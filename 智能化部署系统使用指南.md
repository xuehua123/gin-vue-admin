# 🚀 智能化增量部署系统使用指南

## 📋 **系统概述**

本系统实现了基于文件变化检测的智能化增量部署，支持前后端独立部署，大幅提升开发效率。

## 🎯 **核心特性**

### ✨ **智能检测机制**
- 🔍 **自动检测**：Git提交时自动检测变化文件
- 🎯 **精准定位**：识别前端、后端、配置文件变化
- ⚡ **按需部署**：只部署有变化的服务组件
- 🔄 **零干扰**：无变化的服务保持运行

### 📊 **性能提升对比**

| 部署场景 | 传统全量部署 | 智能增量部署 | 时间节约 |
|---------|-------------|-------------|----------|
| 🎨 前端修改 | 8-12分钟 | **3-5分钟** | **60%+** |
| 🔧 后端修改 | 8-12分钟 | **4-6分钟** | **50%+** |
| ⚙️ 配置修改 | 8-12分钟 | **2-3分钟** | **75%+** |
| 🚨 紧急修复 | 8-12分钟 | **1-2分钟** | **85%+** |

## 🛠️ **部署工作流**

### 1️⃣ **智能增量部署** (`smart-deploy.yml`)

#### **触发条件**
- 推送到 `dev-mqtt` 或 `main` 分支
- 手动触发（可选择强制全量部署）

#### **智能检测规则**
```yaml
backend:
  - 'server/**'              # 后端代码
  - 'deploy/docker-compose.yml'
  - 'deploy/mysql/**'
  - 'deploy/redis/**'

frontend:
  - 'web/**'                 # 前端代码
  - '!web/node_modules/**'   # 排除依赖

docker:
  - 'deploy/**'              # 部署配置
  - 'Dockerfile'
  - 'docker-compose.yml'
```

#### **部署策略**
- **前端变化** → 只重建前端服务
- **后端变化** → 只重建后端服务  
- **配置变化** → 触发全量部署
- **手动强制** → 全量重新部署

### 2️⃣ **紧急修复部署** (`fix-frontend.yml`)

#### **使用场景**
- 🚨 生产环境紧急问题
- 🔧 配置文件快速修复
- ⚡ 不等待自动触发的立即部署

#### **修复内容**
- 自动创建前端环境配置文件
- 重建并重启相关服务
- 实时健康检查和状态反馈

## 📝 **使用方法**

### 🔄 **日常开发流程**

#### **1. 推送代码自动部署**
```bash
# 修改前端代码
git add web/
git commit -m "🎨 优化前端界面"
git push
# → 系统自动检测，只部署前端（3-5分钟）

# 修改后端代码  
git add server/
git commit -m "🔧 修复后端API"
git push
# → 系统自动检测，只部署后端（4-6分钟）

# 修改配置文件
git add deploy/
git commit -m "⚙️ 更新部署配置"
git push
# → 系统自动检测，全量部署（8-12分钟）
```

#### **2. 手动强制部署**
1. 进入 **GitHub Actions**
2. 选择 `🚀 Smart Deployment - 智能化增量部署`
3. 点击 `Run workflow`
4. 勾选 `强制部署所有服务`（可选）
5. 点击 `Run workflow`

#### **3. 紧急问题修复**
1. 进入 **GitHub Actions**
2. 选择 `🔧 Emergency Frontend Fix - 紧急修复前端配置`
3. 点击 `Run workflow`
4. 填写修复描述（可选）
5. 点击 `Run workflow`
6. **1-2分钟**内完成修复

## 🔍 **监控和诊断**

### 📊 **部署状态监控**
- ✅ **成功**：绿色标记，服务正常运行
- ⚠️ **警告**：黄色标记，部分服务异常
- ❌ **失败**：红色标记，部署失败

### 🔧 **故障排查**
#### **查看部署日志**
1. 进入 GitHub Actions
2. 点击对应的工作流运行记录
3. 展开具体的作业步骤
4. 查看详细的执行日志

#### **常见问题解决**
```bash
# 1. 服务启动失败
docker-compose -f deploy/docker-compose.yml logs <service-name>

# 2. 端口冲突
docker-compose -f deploy/docker-compose.yml ps
ss -tlnp | grep -E ':(80|8888|3306|6379)'

# 3. 健康检查失败
curl -f -s http://localhost:80      # 前端
curl -f -s http://localhost:8888/health  # 后端
```

## 🎯 **最佳实践**

### ✅ **推荐做法**
1. **小步快跑**：频繁小改动，触发快速增量部署
2. **明确提交**：使用清晰的提交信息，便于问题追踪
3. **分离关注**：前后端修改分别提交，避免无关重启
4. **及时验证**：部署后立即验证功能正常

### ❌ **避免行为**
1. **混合提交**：避免同时修改前后端和配置文件
2. **忽略日志**：部署失败时不查看详细日志
3. **频繁强制**：避免不必要的全量部署
4. **并发操作**：避免同时触发多个部署流程

## 🔧 **配置说明**

### 📁 **环境配置文件**

#### **生产环境** (`web/.env.production`)
```env
VITE_CLI_PORT = 80
VITE_SERVER_PORT = 8888
VITE_BASE_API = '/api'
VITE_BASE_PATH = ''
VITE_EDITOR = vscode
VITE_POSITION = open
```

#### **开发环境** (`web/.env.development`)
```env
VITE_CLI_PORT = 3000
VITE_SERVER_PORT = 8888
VITE_BASE_API = '/api'
VITE_BASE_PATH = 'http://localhost'
VITE_EDITOR = vscode
VITE_POSITION = open
```

### 🎯 **关键配置说明**
- `VITE_BASE_API`：API请求路径前缀
- `VITE_BASE_PATH`：基础路径（生产环境为空，开发环境为localhost）
- `VITE_SERVER_PORT`：后端服务端口
- `VITE_CLI_PORT`：前端服务端口

## 🚀 **升级和维护**

### 🔄 **系统更新**
- 工作流文件在 `.github/workflows/` 目录
- 可根据项目需要调整检测规则和部署策略
- 支持添加更多的服务组件检测

### 📈 **性能优化**
- 定期清理Docker镜像和容器
- 监控部署时间和成功率
- 根据使用情况调整超时时间和重试次数

## 🎉 **总结**

智能化增量部署系统为您提供：
- ⚡ **极速部署**：根据变化智能选择部署策略
- 🎯 **精准高效**：只部署需要更新的服务
- 🛡️ **稳定可靠**：详细的健康检查和错误处理
- 📊 **透明监控**：实时状态反馈和详细日志

让您的开发效率提升60%以上，专注于核心业务逻辑的实现！ 
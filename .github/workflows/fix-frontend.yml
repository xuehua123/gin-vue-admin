name: ğŸš€ Deploy All Services - å…¨é‡éƒ¨ç½²

on:
  workflow_dispatch:
    inputs:
      description:
        description: 'éƒ¨ç½²æè¿°'
        required: false
        default: 'å…¨é‡éƒ¨ç½²æ‰€æœ‰æœåŠ¡'

jobs:
  deploy-all:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ æ‰§è¡Œå…¨é‡éƒ¨ç½²
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          password: ${{ secrets.PROD_PASSWORD }}
          port: ${{ secrets.PROD_PORT }}
          script: |
            echo "ğŸš€ å¼€å§‹å…¨é‡éƒ¨ç½²æ‰€æœ‰æœåŠ¡..."
            
            # ç¡®ä¿ Docker ç¯å¢ƒæ˜¯æœ€æ–°ç‰ˆæœ¬
            echo "ğŸ³ æ£€æŸ¥å¹¶æ›´æ–° Docker ç¯å¢ƒ..."
            if ! command -v docker &> /dev/null || ! docker compose version &> /dev/null; then
              echo "ğŸš€ Docker æˆ– Docker Compose V2 æœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…/æ›´æ–°..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
              echo "âœ… Docker ç¯å¢ƒæ›´æ–°å®Œæˆ"
            else
              echo "âœ… Docker ç¯å¢ƒå·²æ˜¯æœ€æ–°æˆ–å·²å®‰è£… Compose V2."
            fi

            cd /opt/gin-vue-admin

            # æ­¥éª¤ 1: å¼ºåˆ¶æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸšš [1/5] è·å–æœ€æ–°ä»£ç å¹¶å¼ºåˆ¶è¦†ç›–æœ¬åœ°..."
            git fetch origin
            git reset --hard origin/dev-mqtt

            # æ­¥éª¤ 2: åˆ›å»ºå‰ç«¯ç¯å¢ƒé…ç½®æ–‡ä»¶
            echo "ğŸ“ [2/5] åˆ›å»ºå‰ç«¯ç”Ÿäº§ç¯å¢ƒé…ç½®..."
            cat > web/.env.production << 'EOF'
            VITE_CLI_PORT = 80
            VITE_SERVER_PORT = 8888
            VITE_BASE_API = '/api'
            VITE_BASE_PATH = ''
            VITE_EDITOR = vscode
            VITE_POSITION = open
            EOF

            # æ­¥éª¤ 3: åœæ­¢å¹¶ç§»é™¤æ—§æœåŠ¡
            echo "â¹ï¸ [3/5] åœæ­¢å¹¶ç§»é™¤æ‰€æœ‰æ—§æœåŠ¡..."
            docker compose -f deploy/docker-compose.yml down --remove-orphans

            # æ­¥éª¤ 4: é‡å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
            echo "ğŸ”¨ [4/5] é‡å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡..."
            docker compose -f deploy/docker-compose.yml up -d --build --no-cache

            # æ­¥éª¤ 5: å…¨é¢å¥åº·æ£€æŸ¥
            echo "ğŸ¥ [5/5] æ‰§è¡Œå…¨é¢æœåŠ¡å¥åº·æ£€æŸ¥..."
            echo "â° ç­‰å¾…æœåŠ¡ç¨³å®šå¯åŠ¨ (60ç§’)..."
            sleep 60

            # æ£€æŸ¥å‰ç«¯
            if curl -f -s http://localhost:80 > /dev/null; then
                echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
            else
                echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
                echo "--- å‰ç«¯æœåŠ¡æ—¥å¿— ---"
                docker compose -f deploy/docker-compose.yml logs --tail=50 frontend
            fi

            # æ£€æŸ¥åç«¯
            if curl -f -s http://localhost:8888/health > /dev/null; then
                echo "âœ… åç«¯æœåŠ¡æ­£å¸¸"
            else
                echo "âŒ åç«¯æœåŠ¡å¼‚å¸¸"
                echo "--- åç«¯æœåŠ¡æ—¥å¿— ---"
                docker compose -f deploy/docker-compose.yml logs --tail=50 backend
            fi

            echo "ğŸ‰ éƒ¨ç½²æµç¨‹æ‰§è¡Œå®Œæ¯•ï¼"
            echo "ğŸ“Š æœ€ç»ˆæœåŠ¡çŠ¶æ€ï¼š"
            docker compose -f deploy/docker-compose.yml ps 
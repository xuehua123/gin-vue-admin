name: ğŸ”§ Emergency Frontend Fix - ç´§æ€¥ä¿®å¤å‰ç«¯é…ç½®

on:
  workflow_dispatch:
    inputs:
      description:
        description: 'ä¿®å¤æè¿°'
        required: false
        default: 'ä¿®å¤å‰ç«¯ç¯å¢ƒé…ç½®é—®é¢˜'

jobs:
  fix-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”§ ç´§æ€¥ä¿®å¤å‰ç«¯é…ç½®
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            echo "ğŸš¨ ç´§æ€¥ä¿®å¤å‰ç«¯é…ç½®é—®é¢˜..."
            cd /opt/gin-vue-admin
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            git pull origin dev-mqtt
            
            echo "ğŸ“ åˆ›å»ºå‰ç«¯ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶..."
            cat > web/.env.production << 'EOF'
            VITE_CLI_PORT = 80
            VITE_SERVER_PORT = 8888
            VITE_BASE_API = '/api'
            VITE_BASE_PATH = ''
            VITE_EDITOR = vscode
            VITE_POSITION = open
            EOF
            
            echo "ğŸ“ åˆ›å»ºå‰ç«¯å¼€å‘ç¯å¢ƒé…ç½®æ–‡ä»¶..."
            cat > web/.env.development << 'EOF'
            VITE_CLI_PORT = 3000
            VITE_SERVER_PORT = 8888
            VITE_BASE_API = '/api'
            VITE_BASE_PATH = 'http://localhost'
            VITE_EDITOR = vscode
            VITE_POSITION = open
            EOF
            
            echo "ğŸ” éªŒè¯é…ç½®æ–‡ä»¶..."
            echo "ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼š"
            cat web/.env.production
            echo -e "\nå¼€å‘ç¯å¢ƒé…ç½®ï¼š"
            cat web/.env.development
            
            echo "ğŸ”¨ é‡å»ºå‰ç«¯æœåŠ¡..."
            docker-compose -f deploy/docker-compose.yml build frontend
            
            echo "ğŸ”„ é‡å¯å‰ç«¯æœåŠ¡..."
            docker-compose -f deploy/docker-compose.yml stop frontend
            docker-compose -f deploy/docker-compose.yml up -d frontend
            
            echo "â° ç­‰å¾…å‰ç«¯æœåŠ¡å¯åŠ¨..."
            sleep 30
            
            echo "ğŸ¥ å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥..."
            for i in {1..20}; do
                if curl -f -s http://localhost:80 > /dev/null 2>&1; then
                    echo "âœ… å‰ç«¯æœåŠ¡ä¿®å¤æˆåŠŸï¼"
                    echo "ğŸ“± è®¿é—®åœ°å€: http://43.165.186.134"
                    break
                fi
                if [ $i -eq 20 ]; then
                    echo "âŒ å‰ç«¯æœåŠ¡ä»æœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
                    docker-compose -f deploy/docker-compose.yml logs --tail=30 frontend
                    echo "ğŸ” æ£€æŸ¥nginxé…ç½®ï¼š"
                    docker exec gin-vue-admin-frontend cat /etc/nginx/conf.d/default.conf
                    exit 1
                fi
                echo "â³ ç­‰å¾…å‰ç«¯æœåŠ¡... ($i/20)"
                sleep 3
            done
            
            echo "ğŸ‰ å‰ç«¯é…ç½®ä¿®å¤å®Œæˆï¼"
            echo "ğŸ“Š æœ€ç»ˆæœåŠ¡çŠ¶æ€ï¼š"
            docker-compose -f deploy/docker-compose.yml ps 
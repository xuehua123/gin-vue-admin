name: ðŸš€ Smart Deployment - æ™ºèƒ½åŒ–å¢žé‡éƒ¨ç½²

on:
  push:
    branches: [ dev-mqtt, main ]
  workflow_dispatch:
    inputs:
      force_deploy_all:
        description: 'å¼ºåˆ¶éƒ¨ç½²æ‰€æœ‰æœåŠ¡'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  IMAGE_PREFIX: gva

jobs:
  # æ£€æµ‹å˜åŒ–çš„æ–‡ä»¶å’ŒæœåŠ¡
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend_changed: ${{ steps.changes.outputs.backend }}
      frontend_changed: ${{ steps.changes.outputs.frontend }}
      infra_changed: ${{ steps.changes.outputs.infra }}
      deploy_all: ${{ github.event.inputs.force_deploy_all == true || steps.force-all.outputs.force == 'true' }}
    steps:
      - name: ðŸ” æ£€æŸ¥ä»£ç å˜åŒ–
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ðŸ”„ æ£€æµ‹æœåŠ¡å˜åŒ–
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            backend:
              - 'server/**'
            frontend:
              - 'web/**'
              - '!web/node_modules/**'
            infra:
              - 'deploy/**'
              - '**/Dockerfile'
              - '**/docker-compose.yml'
      
      - name: ðŸŽ¯ æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåˆ¶å…¨é‡éƒ¨ç½²
        id: force-all
        run: |
          # å¦‚æžœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”æ²¡æœ‰å¼ºåˆ¶å…¨é‡éƒ¨ç½²ï¼Œæˆ–è€…åŸºç¡€è®¾æ–½æ–‡ä»¶å‘ç”Ÿå˜åŒ–ï¼Œåˆ™éœ€è¦å…¨é‡éƒ¨ç½²
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.force_deploy_all }}" != "true" ]]; then
            echo "force=false" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.changes.outputs.infra }}" == "true" ]]; then
            echo "force=true" >> $GITHUB_OUTPUT
          else
            echo "force=false" >> $GITHUB_OUTPUT
          fi

  # æ™ºèƒ½éƒ¨ç½²åŽç«¯æœåŠ¡
  deploy-backend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend_changed == 'true' && needs.detect-changes.outputs.frontend_changed == 'false' && needs.detect-changes.outputs.deploy_all == 'false'
    steps:
      - name: ðŸš€ éƒ¨ç½²åŽç«¯æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
            cd /opt/gin-vue-admin
            
            # é€šç”¨åˆå§‹åŒ–å‡½æ•°
            init_deployment() {
              echo "ðŸ”§ åˆå§‹åŒ–éƒ¨ç½²çŽ¯å¢ƒ..."
              
              # æ£€æŸ¥å¹¶åˆ›å»º/å¯ç”¨ Swap äº¤æ¢ç©ºé—´ï¼ˆä»…åœ¨éœ€è¦æ—¶ï¼‰
              if [ "$(free | grep Swap | awk '{print $2}')" -eq 0 ]; then
                echo "ðŸ¤” æœªå‘çŽ°Swap, æ­£åœ¨åˆ›å»º4GB Swapç©ºé—´..."
                sudo fallocate -l 4G /swapfile 2>/dev/null || sudo dd if=/dev/zero of=/swapfile bs=1M count=4096
                sudo chmod 600 /swapfile
                sudo mkswap /swapfile
                sudo swapon /swapfile
                echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
                echo "âœ… Swapåˆ›å»ºå¹¶å¯ç”¨æˆåŠŸ!"
              else
                echo "âœ… Swapå·²å­˜åœ¨."
              fi

              # æ‹‰å–æœ€æ–°ä»£ç 
              echo "ðŸ“¥ èŽ·å–æœ€æ–°ä»£ç å¹¶å¼ºåˆ¶è¦†ç›–æœ¬åœ°..."
              git fetch origin
              git reset --hard origin/dev-mqtt
              
              # æ¸…ç†Dockeræž„å»ºç¼“å­˜ï¼ˆæœ‰é€‰æ‹©æ€§çš„æ¸…ç†ï¼‰
              docker builder prune -f --filter="until=168h" || true
            }

            # ç­‰å¾…æœåŠ¡å¥åº·çš„é€šç”¨å‡½æ•°
            wait_for_service() {
              local service_name=$1
              local check_command=$2
              local max_attempts=${3:-30}
              local wait_time=${4:-3}
              
              echo "â° ç­‰å¾… $service_name æœåŠ¡å¥åº·..."
              for i in $(seq 1 $max_attempts); do
                if eval "$check_command" &>/dev/null; then
                  echo "âœ… $service_name æœåŠ¡å·²å¥åº·"
                  return 0
                fi
                echo "â³ ç­‰å¾… $service_name æœåŠ¡å¥åº·... ($i/$max_attempts)"
                sleep $wait_time
              done
              echo "âŒ $service_name æœåŠ¡å¥åº·æ£€æŸ¥è¶…æ—¶"
              return 1
            }
            
            echo "ðŸ”§ æ™ºèƒ½éƒ¨ç½²åŽç«¯æœåŠ¡..."
            init_deployment
            
            # ç¡®ä¿ä¾èµ–æœåŠ¡è¿è¡Œ
            echo "ðŸ” å¯åŠ¨ä¾èµ–æœåŠ¡..."
            docker-compose -f deploy/docker-compose.yml up -d mysql redis
            
            # ç­‰å¾…ä¾èµ–æœåŠ¡å¥åº·
            wait_for_service "MySQL" "docker-compose -f deploy/docker-compose.yml exec -T mysql mysqladmin ping -h localhost -u root --password=Gva123456! --silent" 30 3
            wait_for_service "Redis" "docker-compose -f deploy/docker-compose.yml exec -T redis redis-cli -a Gva123456! ping | grep -q PONG" 20 2
            
            # åªé‡å»ºåŽç«¯æœåŠ¡
            echo "ðŸ”¨ é‡å»ºåŽç«¯é•œåƒ..."
            docker-compose -f deploy/docker-compose.yml build backend
            
            # é‡å¯åŽç«¯æœåŠ¡
            echo "ðŸ”„ é‡å¯åŽç«¯æœåŠ¡..."
            docker-compose -f deploy/docker-compose.yml up -d backend
            
            # å¥åº·æ£€æŸ¥
            if ! wait_for_service "Backend" "curl -f -s http://localhost:8888/health" 30 3; then
              echo "âŒ åŽç«¯æœåŠ¡é‡å¯å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
              docker-compose -f deploy/docker-compose.yml logs --tail=20 backend
              exit 1
            fi
            echo "âœ… åŽç«¯æœåŠ¡éƒ¨ç½²æˆåŠŸ"

  # æ™ºèƒ½éƒ¨ç½²å‰ç«¯æœåŠ¡
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend_changed == 'true' && needs.detect-changes.outputs.backend_changed == 'false' && needs.detect-changes.outputs.deploy_all == 'false'
    steps:
      - name: ðŸš€ éƒ¨ç½²å‰ç«¯æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
            cd /opt/gin-vue-admin
            
            # é€šç”¨åˆå§‹åŒ–å‡½æ•°
            init_deployment() {
              echo "ðŸ”§ åˆå§‹åŒ–éƒ¨ç½²çŽ¯å¢ƒ..."
              
              # æ£€æŸ¥å¹¶åˆ›å»º/å¯ç”¨ Swap äº¤æ¢ç©ºé—´ï¼ˆä»…åœ¨éœ€è¦æ—¶ï¼‰
              if [ "$(free | grep Swap | awk '{print $2}')" -eq 0 ]; then
                echo "ðŸ¤” æœªå‘çŽ°Swap, æ­£åœ¨åˆ›å»º4GB Swapç©ºé—´..."
                sudo fallocate -l 4G /swapfile 2>/dev/null || sudo dd if=/dev/zero of=/swapfile bs=1M count=4096
                sudo chmod 600 /swapfile
                sudo mkswap /swapfile
                sudo swapon /swapfile
                echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
                echo "âœ… Swapåˆ›å»ºå¹¶å¯ç”¨æˆåŠŸ!"
              else
                echo "âœ… Swapå·²å­˜åœ¨."
              fi

              # æ‹‰å–æœ€æ–°ä»£ç 
              echo "ðŸ“¥ èŽ·å–æœ€æ–°ä»£ç å¹¶å¼ºåˆ¶è¦†ç›–æœ¬åœ°..."
              git fetch origin
              git reset --hard origin/dev-mqtt
              
              # æ¸…ç†Dockeræž„å»ºç¼“å­˜ï¼ˆæœ‰é€‰æ‹©æ€§çš„æ¸…ç†ï¼‰
              docker builder prune -f --filter="until=168h" || true
            }

            # ç­‰å¾…æœåŠ¡å¥åº·çš„é€šç”¨å‡½æ•°
            wait_for_service() {
              local service_name=$1
              local check_command=$2
              local max_attempts=${3:-30}
              local wait_time=${4:-3}
              
              echo "â° ç­‰å¾… $service_name æœåŠ¡å¥åº·..."
              for i in $(seq 1 $max_attempts); do
                if eval "$check_command" &>/dev/null; then
                  echo "âœ… $service_name æœåŠ¡å·²å¥åº·"
                  return 0
                fi
                echo "â³ ç­‰å¾… $service_name æœåŠ¡å¥åº·... ($i/$max_attempts)"
                sleep $wait_time
              done
              echo "âŒ $service_name æœåŠ¡å¥åº·æ£€æŸ¥è¶…æ—¶"
              return 1
            }

            # åˆ›å»ºå‰ç«¯çŽ¯å¢ƒé…ç½®
            create_frontend_config() {
              echo "ðŸ“ åˆ›å»ºå‰ç«¯ç”Ÿäº§çŽ¯å¢ƒé…ç½®..."
              cat > web/.env.production << 'EOF'
            VITE_CLI_PORT = 80
            VITE_SERVER_PORT = 8888
            VITE_BASE_API = '/api'
            VITE_BASE_PATH = ''
            VITE_EDITOR = vscode
            VITE_POSITION = open
            EOF
            }
            
            echo "ðŸŽ¨ æ™ºèƒ½éƒ¨ç½²å‰ç«¯æœåŠ¡..."
            init_deployment
            create_frontend_config
            
            # ç¡®ä¿åŽç«¯æœåŠ¡è¿è¡Œ
            echo "ðŸ” ç¡®ä¿ä¾èµ–æœåŠ¡çŠ¶æ€..."
            docker-compose -f deploy/docker-compose.yml up -d mysql redis backend
            
            # ç­‰å¾…åŽç«¯æœåŠ¡å¥åº·
            if ! wait_for_service "Backend" "curl -f -s http://localhost:8888/health" 20 3; then
              echo "âš ï¸ åŽç«¯æœåŠ¡æœªå®Œå…¨å°±ç»ªï¼Œä½†ç»§ç»­å‰ç«¯éƒ¨ç½²"
            fi
            
            # åªé‡å»ºå‰ç«¯æœåŠ¡
            echo "ðŸ”¨ é‡å»ºå‰ç«¯é•œåƒ..."
            docker-compose -f deploy/docker-compose.yml build --no-cache frontend
            
            # é‡å¯å‰ç«¯æœåŠ¡
            echo "ðŸ”„ é‡å¯å‰ç«¯æœåŠ¡..."
            docker-compose -f deploy/docker-compose.yml up -d frontend
            
            # å¥åº·æ£€æŸ¥
            if ! wait_for_service "Frontend" "curl -f -s http://localhost:80" 15 2; then
              echo "âŒ å‰ç«¯æœåŠ¡é‡å¯å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
              docker-compose -f deploy/docker-compose.yml logs --tail=20 frontend
              exit 1
            fi
            echo "âœ… å‰ç«¯æœåŠ¡éƒ¨ç½²æˆåŠŸ"

  # æ™ºèƒ½éƒ¨ç½²å¤šä¸ªæœåŠ¡ï¼ˆå½“å‰ç«¯å’ŒåŽç«¯åŒæ—¶å˜åŒ–æ—¶ï¼‰
  deploy-multiple:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend_changed == 'true' && needs.detect-changes.outputs.frontend_changed == 'true' && needs.detect-changes.outputs.deploy_all == 'false'
    steps:
      - name: ðŸš€ æ™ºèƒ½éƒ¨ç½²å¤šä¸ªæœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
            cd /opt/gin-vue-admin
            
            # é€šç”¨åˆå§‹åŒ–å‡½æ•°
            init_deployment() {
              echo "ðŸ”§ åˆå§‹åŒ–éƒ¨ç½²çŽ¯å¢ƒ..."
              
              # æ£€æŸ¥å¹¶åˆ›å»º/å¯ç”¨ Swap äº¤æ¢ç©ºé—´ï¼ˆä»…åœ¨éœ€è¦æ—¶ï¼‰
              if [ "$(free | grep Swap | awk '{print $2}')" -eq 0 ]; then
                echo "ðŸ¤” æœªå‘çŽ°Swap, æ­£åœ¨åˆ›å»º4GB Swapç©ºé—´..."
                sudo fallocate -l 4G /swapfile 2>/dev/null || sudo dd if=/dev/zero of=/swapfile bs=1M count=4096
                sudo chmod 600 /swapfile
                sudo mkswap /swapfile
                sudo swapon /swapfile
                echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
                echo "âœ… Swapåˆ›å»ºå¹¶å¯ç”¨æˆåŠŸ!"
              else
                echo "âœ… Swapå·²å­˜åœ¨."
              fi

              # æ‹‰å–æœ€æ–°ä»£ç 
              echo "ðŸ“¥ èŽ·å–æœ€æ–°ä»£ç å¹¶å¼ºåˆ¶è¦†ç›–æœ¬åœ°..."
              git fetch origin
              git reset --hard origin/dev-mqtt
              
              # æ¸…ç†Dockeræž„å»ºç¼“å­˜ï¼ˆæœ‰é€‰æ‹©æ€§çš„æ¸…ç†ï¼‰
              docker builder prune -f --filter="until=168h" || true
            }

            # ç­‰å¾…æœåŠ¡å¥åº·çš„é€šç”¨å‡½æ•°
            wait_for_service() {
              local service_name=$1
              local check_command=$2
              local max_attempts=${3:-30}
              local wait_time=${4:-3}
              
              echo "â° ç­‰å¾… $service_name æœåŠ¡å¥åº·..."
              for i in $(seq 1 $max_attempts); do
                if eval "$check_command" &>/dev/null; then
                  echo "âœ… $service_name æœåŠ¡å·²å¥åº·"
                  return 0
                fi
                echo "â³ ç­‰å¾… $service_name æœåŠ¡å¥åº·... ($i/$max_attempts)"
                sleep $wait_time
              done
              echo "âŒ $service_name æœåŠ¡å¥åº·æ£€æŸ¥è¶…æ—¶"
              return 1
            }

            # åˆ›å»ºå‰ç«¯çŽ¯å¢ƒé…ç½®
            create_frontend_config() {
              echo "ðŸ“ åˆ›å»ºå‰ç«¯ç”Ÿäº§çŽ¯å¢ƒé…ç½®..."
              cat > web/.env.production << 'EOF'
            VITE_CLI_PORT = 80
            VITE_SERVER_PORT = 8888
            VITE_BASE_API = '/api'
            VITE_BASE_PATH = ''
            VITE_EDITOR = vscode
            VITE_POSITION = open
            EOF
            }
            
            echo "ðŸ”§ æ™ºèƒ½éƒ¨ç½²å‰ç«¯å’ŒåŽç«¯æœåŠ¡..."
            init_deployment
            create_frontend_config
            
            # ç¡®ä¿ä¾èµ–æœåŠ¡è¿è¡Œ
            echo "ðŸ” å¯åŠ¨ä¾èµ–æœåŠ¡..."
            docker-compose -f deploy/docker-compose.yml up -d mysql redis
            
            # ç­‰å¾…ä¾èµ–æœåŠ¡å¥åº·
            wait_for_service "MySQL" "docker-compose -f deploy/docker-compose.yml exec -T mysql mysqladmin ping -h localhost -u root --password=Gva123456! --silent" 30 3
            wait_for_service "Redis" "docker-compose -f deploy/docker-compose.yml exec -T redis redis-cli -a Gva123456! ping | grep -q PONG" 20 2
            
            # é‡å»ºå‰ç«¯å’ŒåŽç«¯æœåŠ¡
            echo "ðŸ”¨ é‡å»ºå‰ç«¯å’ŒåŽç«¯é•œåƒ..."
            docker-compose -f deploy/docker-compose.yml build --no-cache frontend backend
            
            # é‡å¯æœåŠ¡
            echo "ðŸ”„ é‡å¯å‰ç«¯å’ŒåŽç«¯æœåŠ¡..."
            docker-compose -f deploy/docker-compose.yml up -d frontend backend
            
            # å¥åº·æ£€æŸ¥
            echo "ðŸ¥ æœåŠ¡å¥åº·æ£€æŸ¥..."
            sleep 30  # ç»™æœåŠ¡ä¸€äº›å¯åŠ¨æ—¶é—´
            
            # æ£€æŸ¥å‰ç«¯
            if ! wait_for_service "Frontend" "curl -f -s http://localhost:80" 15 2; then
              echo "âŒ å‰ç«¯æœåŠ¡é‡å¯å¤±è´¥"
              docker-compose -f deploy/docker-compose.yml logs --tail=20 frontend
            fi
            
            # æ£€æŸ¥åŽç«¯
            if ! wait_for_service "Backend" "curl -f -s http://localhost:8888/health" 30 3; then
              echo "âŒ åŽç«¯æœåŠ¡é‡å¯å¤±è´¥"
              docker-compose -f deploy/docker-compose.yml logs --tail=20 backend
              exit 1
            fi
            echo "âœ… å¤šæœåŠ¡éƒ¨ç½²æˆåŠŸ"

  # å…¨é‡éƒ¨ç½²ï¼ˆå¤‡ç”¨ï¼‰
  deploy-all:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.deploy_all == 'true'
    steps:
      - name: ðŸš€ å…¨é‡éƒ¨ç½²æ‰€æœ‰æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
            cd /opt/gin-vue-admin
            
            # é€šç”¨åˆå§‹åŒ–å‡½æ•°
            init_deployment() {
              echo "ðŸ”§ åˆå§‹åŒ–éƒ¨ç½²çŽ¯å¢ƒ..."
              
              # æ£€æŸ¥å¹¶åˆ›å»º/å¯ç”¨ Swap äº¤æ¢ç©ºé—´ï¼ˆä»…åœ¨éœ€è¦æ—¶ï¼‰
              if [ "$(free | grep Swap | awk '{print $2}')" -eq 0 ]; then
                echo "ðŸ¤” æœªå‘çŽ°Swap, æ­£åœ¨åˆ›å»º4GB Swapç©ºé—´..."
                sudo fallocate -l 4G /swapfile 2>/dev/null || sudo dd if=/dev/zero of=/swapfile bs=1M count=4096
                sudo chmod 600 /swapfile
                sudo mkswap /swapfile
                sudo swapon /swapfile
                echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
                echo "âœ… Swapåˆ›å»ºå¹¶å¯ç”¨æˆåŠŸ!"
              else
                echo "âœ… Swapå·²å­˜åœ¨."
              fi

              # æ‹‰å–æœ€æ–°ä»£ç 
              echo "ðŸ“¥ èŽ·å–æœ€æ–°ä»£ç å¹¶å¼ºåˆ¶è¦†ç›–æœ¬åœ°..."
              git fetch origin
              git reset --hard origin/dev-mqtt
              
              # æ¸…ç†Dockeræž„å»ºç¼“å­˜ï¼ˆæœ‰é€‰æ‹©æ€§çš„æ¸…ç†ï¼‰
              docker builder prune -f --filter="until=168h" || true
            }

            # ç­‰å¾…æœåŠ¡å¥åº·çš„é€šç”¨å‡½æ•°
            wait_for_service() {
              local service_name=$1
              local check_command=$2
              local max_attempts=${3:-30}
              local wait_time=${4:-3}
              
              echo "â° ç­‰å¾… $service_name æœåŠ¡å¥åº·..."
              for i in $(seq 1 $max_attempts); do
                if eval "$check_command" &>/dev/null; then
                  echo "âœ… $service_name æœåŠ¡å·²å¥åº·"
                  return 0
                fi
                echo "â³ ç­‰å¾… $service_name æœåŠ¡å¥åº·... ($i/$max_attempts)"
                sleep $wait_time
              done
              echo "âŒ $service_name æœåŠ¡å¥åº·æ£€æŸ¥è¶…æ—¶"
              return 1
            }

            # åˆ›å»ºå‰ç«¯çŽ¯å¢ƒé…ç½®
            create_frontend_config() {
              echo "ðŸ“ åˆ›å»ºå‰ç«¯ç”Ÿäº§çŽ¯å¢ƒé…ç½®..."
              cat > web/.env.production << 'EOF'
            VITE_CLI_PORT = 80
            VITE_SERVER_PORT = 8888
            VITE_BASE_API = '/api'
            VITE_BASE_PATH = ''
            VITE_EDITOR = vscode
            VITE_POSITION = open
            EOF
            }
            
            echo "ðŸš€ å…¨é‡éƒ¨ç½²æ‰€æœ‰æœåŠ¡..."
            init_deployment
            create_frontend_config
            
            # åœæ­¢æ‰€æœ‰æœåŠ¡
            echo "â¹ï¸ åœæ­¢æ—§æœåŠ¡..."
            docker-compose -f deploy/docker-compose.yml down || true
            
            # é‡å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
            echo "ðŸ”¨ é‡å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡..."
            docker-compose -f deploy/docker-compose.yml build --no-cache
            docker-compose -f deploy/docker-compose.yml up -d
            
            # å…¨é¢å¥åº·æ£€æŸ¥
            echo "ðŸ¥ å…¨é¢æœåŠ¡å¥åº·æ£€æŸ¥..."
            sleep 60  # ç»™æ‰€æœ‰æœåŠ¡å……è¶³çš„å¯åŠ¨æ—¶é—´
            
            # æ£€æŸ¥å‰ç«¯
            if wait_for_service "Frontend" "curl -f -s http://localhost:80" 20 3; then
              echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
            else
              echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
            fi
            
            # æ£€æŸ¥åŽç«¯
            if wait_for_service "Backend" "curl -f -s http://localhost:8888/health" 30 3; then
              echo "âœ… åŽç«¯æœåŠ¡æ­£å¸¸"
            else
              echo "âŒ åŽç«¯æœåŠ¡å¼‚å¸¸"
              docker-compose -f deploy/docker-compose.yml logs --tail=30 backend
              exit 1
            fi
            echo "âœ… å…¨é‡éƒ¨ç½²å®Œæˆ"

  # éƒ¨ç½²çŠ¶æ€é€šçŸ¥
  notify:
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-backend, deploy-frontend, deploy-multiple, deploy-all]
    if: always()
    steps:
      - name: ðŸ“¢ éƒ¨ç½²ç»“æžœé€šçŸ¥
        run: |
          echo "ðŸŽ¯ æ™ºèƒ½éƒ¨ç½²å®Œæˆï¼"
          echo "ðŸ“‹ å˜åŒ–æ£€æµ‹ç»“æžœï¼š"
          echo "  - åŽç«¯å˜åŒ–: ${{ needs.detect-changes.outputs.backend_changed }}"
          echo "  - å‰ç«¯å˜åŒ–: ${{ needs.detect-changes.outputs.frontend_changed }}"
          echo "  - åŸºç¡€è®¾æ–½å˜åŒ–: ${{ needs.detect-changes.outputs.infra_changed }}"
          echo "  - è§¦å‘å…¨é‡éƒ¨ç½²: ${{ needs.detect-changes.outputs.deploy_all }}"
          
          echo "ðŸš€ éƒ¨ç½²æ‰§è¡Œæƒ…å†µï¼š"
          for job in deploy-backend deploy-frontend deploy-multiple deploy-all; do
            result_var="needs.${job}.result"
            result="${{ needs.deploy-backend.result }}${{ needs.deploy-frontend.result }}${{ needs.deploy-multiple.result }}${{ needs.deploy-all.result }}"
            
            case "${job}" in
              "deploy-backend")
                result="${{ needs.deploy-backend.result }}"
                name="åŽç«¯æœåŠ¡"
                ;;
              "deploy-frontend") 
                result="${{ needs.deploy-frontend.result }}"
                name="å‰ç«¯æœåŠ¡"
                ;;
              "deploy-multiple")
                result="${{ needs.deploy-multiple.result }}"
                name="å¤šæœåŠ¡"
                ;;
              "deploy-all")
                result="${{ needs.deploy-all.result }}"
                name="å…¨é‡"
                ;;
            esac
            
            case "${result}" in
              "success") echo "  âœ… ${name}éƒ¨ç½²æˆåŠŸ" ;;
              "skipped") echo "  â­ï¸ ${name}éƒ¨ç½²è·³è¿‡ï¼ˆæ— å˜åŒ–ï¼‰" ;;
              "failure") echo "  âŒ ${name}éƒ¨ç½²å¤±è´¥" ;;
              "") echo "  â­ï¸ ${name}éƒ¨ç½²æœªæ‰§è¡Œ" ;;
            esac
          done 
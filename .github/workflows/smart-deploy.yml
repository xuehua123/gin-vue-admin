name: ğŸš€ Smart Deployment - æ™ºèƒ½åŒ–å¢é‡éƒ¨ç½²

on:
  push:
    branches: [ dev-mqtt, main ]
  workflow_dispatch:
    inputs:
      force_deploy_all:
        description: 'å¼ºåˆ¶éƒ¨ç½²æ‰€æœ‰æœåŠ¡'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  IMAGE_PREFIX: gva

jobs:
  # æ£€æµ‹å˜åŒ–çš„æ–‡ä»¶å’ŒæœåŠ¡
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend_changed: ${{ steps.changes.outputs.backend }}
      frontend_changed: ${{ steps.changes.outputs.frontend }}
      docker_changed: ${{ steps.changes.outputs.docker }}
      deploy_all: ${{ github.event.inputs.force_deploy_all == 'true' || steps.force-all.outputs.force }}
    steps:
      - name: ğŸ” æ£€æŸ¥ä»£ç å˜åŒ–
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ”„ æ£€æµ‹æœåŠ¡å˜åŒ–
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            backend:
              - 'server/**'
              - 'deploy/docker-compose.yml'
              - 'deploy/mysql/**'
              - 'deploy/redis/**'
            frontend:
              - 'web/**'
              - '!web/node_modules/**'
            docker:
              - 'deploy/**'
              - 'Dockerfile'
              - 'docker-compose.yml'
      
      - name: ğŸ¯ æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåˆ¶å…¨é‡éƒ¨ç½²
        id: force-all
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || [[ "${{ steps.changes.outputs.docker }}" == "true" ]]; then
            echo "force=true" >> $GITHUB_OUTPUT
          else
            echo "force=false" >> $GITHUB_OUTPUT
          fi

  # æ™ºèƒ½éƒ¨ç½²åç«¯æœåŠ¡
  deploy-backend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend_changed == 'true' || needs.detect-changes.outputs.deploy_all == 'true'
    steps:
      - name: ğŸš€ éƒ¨ç½²åç«¯æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            echo "ğŸ”§ æ™ºèƒ½éƒ¨ç½²åç«¯æœåŠ¡..."
            cd /opt/gin-vue-admin
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            git pull origin dev-mqtt
            
            # åªé‡å»ºåç«¯æœåŠ¡
            echo "ğŸ”¨ é‡å»ºåç«¯é•œåƒ..."
            docker-compose -f deploy/docker-compose.yml build backend
            
            # é‡å¯åç«¯æœåŠ¡
            echo "ğŸ”„ é‡å¯åç«¯æœåŠ¡..."
            docker-compose -f deploy/docker-compose.yml up -d backend
            
            # å¥åº·æ£€æŸ¥
            echo "ğŸ¥ åç«¯æœåŠ¡å¥åº·æ£€æŸ¥..."
            for i in {1..30}; do
                if curl -f -s http://localhost:8888/health > /dev/null 2>&1; then
                    echo "âœ… åç«¯æœåŠ¡é‡å¯æˆåŠŸ"
                    break
                fi
                if [ $i -eq 30 ]; then
                    echo "âŒ åç«¯æœåŠ¡é‡å¯å¤±è´¥"
                    docker-compose -f deploy/docker-compose.yml logs --tail=20 backend
                    exit 1
                fi
                echo "â³ ç­‰å¾…åç«¯æœåŠ¡... ($i/30)"
                sleep 3
            done

  # æ™ºèƒ½éƒ¨ç½²å‰ç«¯æœåŠ¡
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend_changed == 'true' || needs.detect-changes.outputs.deploy_all == 'true'
    steps:
      - name: ğŸš€ éƒ¨ç½²å‰ç«¯æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            echo "ğŸ¨ æ™ºèƒ½éƒ¨ç½²å‰ç«¯æœåŠ¡..."
            cd /opt/gin-vue-admin
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            git pull origin dev-mqtt
            
            # åˆ›å»ºå‰ç«¯ç¯å¢ƒé…ç½®æ–‡ä»¶
            echo "ğŸ“ åˆ›å»ºå‰ç«¯ç”Ÿäº§ç¯å¢ƒé…ç½®..."
            cat > web/.env.production << EOF
            VITE_CLI_PORT = 80
            VITE_SERVER_PORT = 8888
            VITE_BASE_API = '/api'
            VITE_BASE_PATH = ''
            VITE_EDITOR = vscode
            VITE_POSITION = open
            EOF
            
            # åªé‡å»ºå‰ç«¯æœåŠ¡
            echo "ğŸ”¨ é‡å»ºå‰ç«¯é•œåƒ..."
            docker-compose -f deploy/docker-compose.yml build frontend
            
            # é‡å¯å‰ç«¯æœåŠ¡
            echo "ğŸ”„ é‡å¯å‰ç«¯æœåŠ¡..."
            docker-compose -f deploy/docker-compose.yml up -d frontend
            
            # å¥åº·æ£€æŸ¥
            echo "ğŸ¥ å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥..."
            for i in {1..15}; do
                if curl -f -s http://localhost:80 > /dev/null 2>&1; then
                    echo "âœ… å‰ç«¯æœåŠ¡é‡å¯æˆåŠŸ"
                    break
                fi
                if [ $i -eq 15 ]; then
                    echo "âŒ å‰ç«¯æœåŠ¡é‡å¯å¤±è´¥"
                    docker-compose -f deploy/docker-compose.yml logs --tail=20 frontend
                    exit 1
                fi
                echo "â³ ç­‰å¾…å‰ç«¯æœåŠ¡... ($i/15)"
                sleep 2
            done

  # å…¨é‡éƒ¨ç½²ï¼ˆå¤‡ç”¨ï¼‰
  deploy-all:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.deploy_all == 'true' && (needs.detect-changes.outputs.docker_changed == 'true' || github.event.inputs.force_deploy_all == 'true')
    steps:
      - name: ğŸš€ å…¨é‡éƒ¨ç½²æ‰€æœ‰æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            echo "ğŸš€ å…¨é‡éƒ¨ç½²æ‰€æœ‰æœåŠ¡..."
            cd /opt/gin-vue-admin
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            git pull origin dev-mqtt
            
            # åˆ›å»ºå‰ç«¯ç¯å¢ƒé…ç½®æ–‡ä»¶
            echo "ğŸ“ åˆ›å»ºå‰ç«¯ç”Ÿäº§ç¯å¢ƒé…ç½®..."
            cat > web/.env.production << EOF
            VITE_CLI_PORT = 80
            VITE_SERVER_PORT = 8888
            VITE_BASE_API = '/api'
            VITE_BASE_PATH = ''
            VITE_EDITOR = vscode
            VITE_POSITION = open
            EOF
            
            # åœæ­¢æ‰€æœ‰æœåŠ¡
            echo "â¹ï¸ åœæ­¢æ—§æœåŠ¡..."
            docker-compose -f deploy/docker-compose.yml down
            
            # é‡å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
            echo "ğŸ”¨ é‡å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡..."
            docker-compose -f deploy/docker-compose.yml up -d --build
            
            # å…¨é¢å¥åº·æ£€æŸ¥
            echo "ğŸ¥ å…¨é¢æœåŠ¡å¥åº·æ£€æŸ¥..."
            sleep 60
            
            # æ£€æŸ¥å‰ç«¯
            if curl -f -s http://localhost:80 > /dev/null; then
                echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
            else
                echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
            fi
            
            # æ£€æŸ¥åç«¯
            if curl -f -s http://localhost:8888/health > /dev/null; then
                echo "âœ… åç«¯æœåŠ¡æ­£å¸¸"
            else
                echo "âŒ åç«¯æœåŠ¡å¼‚å¸¸"
            fi

  # éƒ¨ç½²çŠ¶æ€é€šçŸ¥
  notify:
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-backend, deploy-frontend, deploy-all]
    if: always()
    steps:
      - name: ğŸ“¢ éƒ¨ç½²ç»“æœé€šçŸ¥
        run: |
          echo "ğŸ¯ æ™ºèƒ½éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“‹ å˜åŒ–æ£€æµ‹ç»“æœï¼š"
          echo "  - åç«¯å˜åŒ–: ${{ needs.detect-changes.outputs.backend_changed }}"
          echo "  - å‰ç«¯å˜åŒ–: ${{ needs.detect-changes.outputs.frontend_changed }}"
          echo "  - Dockerå˜åŒ–: ${{ needs.detect-changes.outputs.docker_changed }}"
          echo "  - å…¨é‡éƒ¨ç½²: ${{ needs.detect-changes.outputs.deploy_all }}"
          
          echo "ğŸš€ éƒ¨ç½²æ‰§è¡Œæƒ…å†µï¼š"
          if [[ "${{ needs.deploy-backend.result }}" == "success" ]]; then
            echo "  âœ… åç«¯æœåŠ¡éƒ¨ç½²æˆåŠŸ"
          elif [[ "${{ needs.deploy-backend.result }}" == "skipped" ]]; then
            echo "  â­ï¸ åç«¯æœåŠ¡è·³è¿‡éƒ¨ç½²ï¼ˆæ— å˜åŒ–ï¼‰"
          elif [[ "${{ needs.deploy-backend.result }}" == "failure" ]]; then
            echo "  âŒ åç«¯æœåŠ¡éƒ¨ç½²å¤±è´¥"
          fi
          
          if [[ "${{ needs.deploy-frontend.result }}" == "success" ]]; then
            echo "  âœ… å‰ç«¯æœåŠ¡éƒ¨ç½²æˆåŠŸ"
          elif [[ "${{ needs.deploy-frontend.result }}" == "skipped" ]]; then
            echo "  â­ï¸ å‰ç«¯æœåŠ¡è·³è¿‡éƒ¨ç½²ï¼ˆæ— å˜åŒ–ï¼‰"
          elif [[ "${{ needs.deploy-frontend.result }}" == "failure" ]]; then
            echo "  âŒ å‰ç«¯æœåŠ¡éƒ¨ç½²å¤±è´¥"
          fi
          
          if [[ "${{ needs.deploy-all.result }}" == "success" ]]; then
            echo "  âœ… å…¨é‡éƒ¨ç½²æˆåŠŸ"
          elif [[ "${{ needs.deploy-all.result }}" == "skipped" ]]; then
            echo "  â­ï¸ å…¨é‡éƒ¨ç½²è·³è¿‡"
          elif [[ "${{ needs.deploy-all.result }}" == "failure" ]]; then
            echo "  âŒ å…¨é‡éƒ¨ç½²å¤±è´¥"
          fi 
name: ğŸš€ Smart Deployment - æ™ºèƒ½åŒ–å¢é‡éƒ¨ç½²

on:
  push:
    branches: [ dev-mqtt, main ]
  workflow_dispatch:
    inputs:
      force_deploy_all:
        description: 'å¼ºåˆ¶éƒ¨ç½²æ‰€æœ‰æœåŠ¡'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  IMAGE_PREFIX: gva

jobs:
  # æ£€æµ‹å˜åŒ–çš„æ–‡ä»¶å’ŒæœåŠ¡
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend_changed: ${{ steps.changes.outputs.backend }}
      frontend_changed: ${{ steps.changes.outputs.frontend }}
      docker_changed: ${{ steps.changes.outputs.docker }}
      deploy_all: ${{ github.event.inputs.force_deploy_all == 'true' || steps.force-all.outputs.force }}
    steps:
      - name: ğŸ” æ£€æŸ¥ä»£ç å˜åŒ–
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ”„ æ£€æµ‹æœåŠ¡å˜åŒ–
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            backend:
              - 'server/**'
              - 'deploy/docker-compose.yml'
              - 'deploy/mysql/**'
              - 'deploy/redis/**'
            frontend:
              - 'web/**'
              - '!web/node_modules/**'
            docker:
              - 'deploy/**'
              - 'Dockerfile'
              - 'docker-compose.yml'
      
      - name: ğŸ¯ æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåˆ¶å…¨é‡éƒ¨ç½²
        id: force-all
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || [[ "${{ steps.changes.outputs.docker }}" == "true" ]]; then
            echo "force=true" >> $GITHUB_OUTPUT
          else
            echo "force=false" >> $GITHUB_OUTPUT
          fi

  # æ™ºèƒ½éƒ¨ç½²åç«¯æœåŠ¡
  deploy-backend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend_changed == 'true' && needs.detect-changes.outputs.deploy_all == 'false'
    steps:
      - name: ğŸš€ éƒ¨ç½²åç«¯æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸ”§ æ™ºèƒ½éƒ¨ç½²åç«¯æœåŠ¡..."
            
            # ç¡®ä¿ Docker ç¯å¢ƒæ˜¯æœ€æ–°ç‰ˆæœ¬
            echo "ğŸ³ æ£€æŸ¥å¹¶æ›´æ–° Docker ç¯å¢ƒ..."
            if ! command -v docker &> /dev/null || ! docker compose version &> /dev/null; then
              echo "ğŸš€ Docker æˆ– Docker Compose V2 æœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…/æ›´æ–°..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
              echo "âœ… Docker ç¯å¢ƒæ›´æ–°å®Œæˆï¼Œè¯·é‡æ–°ç™»å½•ä»¥ä½¿ç”¨æˆ·ç»„ç”Ÿæ•ˆæˆ–åœ¨åç»­å‘½ä»¤ä¸­ä½¿ç”¨ 'newgrp docker'"
            else
              echo "âœ… Docker ç¯å¢ƒå·²æ˜¯æœ€æ–°æˆ–å·²å®‰è£… Compose V2."
            fi

            cd /opt/gin-vue-admin
            
            # æ£€æŸ¥å¹¶åˆ›å»º/å¯ç”¨ Swap äº¤æ¢ç©ºé—´
            if [ "$(sudo swapon --show | wc -l)" -lt 2 ]; then
              echo "ğŸ¤” æœªå‘ç°Swap, æ­£åœ¨åˆ›å»º4GB Swapç©ºé—´..."
              sudo fallocate -l 4G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
              echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
              echo "âœ… Swapåˆ›å»ºå¹¶å¯ç”¨æˆåŠŸ!"
            else
              echo "âœ… Swapå·²å­˜åœ¨."
            fi
            sudo swapon --show

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ è·å–æœ€æ–°ä»£ç å¹¶å¼ºåˆ¶è¦†ç›–æœ¬åœ°..."
            git fetch origin
            git reset --hard origin/dev-mqtt
            
            # æ¸…ç†Dockeræ„å»ºç¼“å­˜
            docker builder prune -f || true

            # ç¡®ä¿ä¾èµ–æœåŠ¡è¿è¡Œ
            echo "ğŸ” æ£€æŸ¥ä¾èµ–æœåŠ¡çŠ¶æ€..."
            docker compose -f deploy/docker-compose.yml up -d mysql redis
            
            # ç­‰å¾…ä¾èµ–æœåŠ¡å¥åº·
            echo "â° ç­‰å¾…ä¾èµ–æœåŠ¡å¥åº·..."
            for i in {1..30}; do
                if docker compose -f deploy/docker-compose.yml ps mysql | grep -q "healthy" && \
                   docker compose -f deploy/docker-compose.yml ps redis | grep -q "healthy"; then
                    echo "âœ… ä¾èµ–æœåŠ¡å¥åº·"
                    break
                fi
                echo "â³ ç­‰å¾…ä¾èµ–æœåŠ¡å¥åº·... ($i/30)"
                sleep 2
            done
            
            # åªé‡å»ºåç«¯æœåŠ¡
            echo "ğŸ”¨ é‡å»ºåç«¯é•œåƒ..."
            docker compose -f deploy/docker-compose.yml build backend
            
            # é‡å¯åç«¯æœåŠ¡
            echo "ğŸ”„ é‡å¯åç«¯æœåŠ¡..."
            docker compose -f deploy/docker-compose.yml up -d backend
            
            # å¥åº·æ£€æŸ¥
            echo "ğŸ¥ åç«¯æœåŠ¡å¥åº·æ£€æŸ¥..."
            for i in {1..30}; do
                if curl -f -s http://localhost:8888/health > /dev/null 2>&1; then
                    echo "âœ… åç«¯æœåŠ¡é‡å¯æˆåŠŸ"
                    break
                fi
                if [ $i -eq 30 ]; then
                    echo "âŒ åç«¯æœåŠ¡é‡å¯å¤±è´¥"
                    docker compose -f deploy/docker-compose.yml logs --tail=20 backend
                    exit 1
                fi
                echo "â³ ç­‰å¾…åç«¯æœåŠ¡... ($i/30)"
                sleep 3
            done

  # æ™ºèƒ½éƒ¨ç½²å‰ç«¯æœåŠ¡
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend_changed == 'true' && needs.detect-changes.outputs.deploy_all == 'false'
    steps:
      - name: ğŸš€ éƒ¨ç½²å‰ç«¯æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸ¨ æ™ºèƒ½éƒ¨ç½²å‰ç«¯æœåŠ¡..."
            
            # ç¡®ä¿ Docker ç¯å¢ƒæ˜¯æœ€æ–°ç‰ˆæœ¬
            echo "ğŸ³ æ£€æŸ¥å¹¶æ›´æ–° Docker ç¯å¢ƒ..."
            if ! command -v docker &> /dev/null || ! docker compose version &> /dev/null; then
              echo "ğŸš€ Docker æˆ– Docker Compose V2 æœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…/æ›´æ–°..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
              echo "âœ… Docker ç¯å¢ƒæ›´æ–°å®Œæˆï¼Œè¯·é‡æ–°ç™»å½•ä»¥ä½¿ç”¨æˆ·ç»„ç”Ÿæ•ˆæˆ–åœ¨åç»­å‘½ä»¤ä¸­ä½¿ç”¨ 'newgrp docker'"
            else
              echo "âœ… Docker ç¯å¢ƒå·²æ˜¯æœ€æ–°æˆ–å·²å®‰è£… Compose V2."
            fi

            cd /opt/gin-vue-admin
            
            # æ£€æŸ¥å¹¶åˆ›å»º/å¯ç”¨ Swap äº¤æ¢ç©ºé—´
            if [ "$(sudo swapon --show | wc -l)" -lt 2 ]; then
              echo "ğŸ¤” æœªå‘ç°Swap, æ­£åœ¨åˆ›å»º4GB Swapç©ºé—´..."
              sudo fallocate -l 4G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
              echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
              echo "âœ… Swapåˆ›å»ºå¹¶å¯ç”¨æˆåŠŸ!"
            else
              echo "âœ… Swapå·²å­˜åœ¨."
            fi
            sudo swapon --show

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ è·å–æœ€æ–°ä»£ç å¹¶å¼ºåˆ¶è¦†ç›–æœ¬åœ°..."
            git fetch origin
            git reset --hard origin/dev-mqtt
            
            # æ¸…ç†Dockeræ„å»ºç¼“å­˜
            docker builder prune -f || true

            # åˆ›å»ºå‰ç«¯ç¯å¢ƒé…ç½®æ–‡ä»¶
            echo "ğŸ“ åˆ›å»ºå‰ç«¯ç”Ÿäº§ç¯å¢ƒé…ç½®..."
            cat > web/.env.production << EOF
            VITE_CLI_PORT = 80
            VITE_SERVER_PORT = 8888
            VITE_BASE_API = '/api'
            VITE_BASE_PATH = ''
            VITE_EDITOR = vscode
            VITE_POSITION = open
            EOF
            
            # ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œ
            echo "ğŸ” æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€..."
            docker compose -f deploy/docker-compose.yml up -d mysql redis backend
            
            # ç­‰å¾…åç«¯æœåŠ¡å¥åº·
            echo "â° ç­‰å¾…åç«¯æœåŠ¡å¥åº·..."
            for i in {1..20}; do
                if curl -f -s http://localhost:8888/health > /dev/null 2>&1; then
                    echo "âœ… åç«¯æœåŠ¡å¥åº·"
                    break
                fi
                echo "â³ ç­‰å¾…åç«¯æœåŠ¡å¥åº·... ($i/20)"
                sleep 3
            done
            
            # åªé‡å»ºå‰ç«¯æœåŠ¡
            echo "ğŸ”¨ é‡å»ºå‰ç«¯é•œåƒ..."
            docker compose -f deploy/docker-compose.yml build --no-cache frontend
            
            # é‡å¯å‰ç«¯æœåŠ¡
            echo "ğŸ”„ é‡å¯å‰ç«¯æœåŠ¡..."
            docker compose -f deploy/docker-compose.yml up -d frontend
            
            # å¥åº·æ£€æŸ¥
            echo "ğŸ¥ å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥..."
            for i in {1..15}; do
                if curl -f -s http://localhost:80 > /dev/null 2>&1; then
                    echo "âœ… å‰ç«¯æœåŠ¡é‡å¯æˆåŠŸ"
                    break
                fi
                if [ $i -eq 15 ]; then
                    echo "âŒ å‰ç«¯æœåŠ¡é‡å¯å¤±è´¥"
                    docker compose -f deploy/docker-compose.yml logs --tail=20 frontend
                    exit 1
                fi
                echo "â³ ç­‰å¾…å‰ç«¯æœåŠ¡... ($i/15)"
                sleep 2
            done

  # å…¨é‡éƒ¨ç½²ï¼ˆå¤‡ç”¨ï¼‰
  deploy-all:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.deploy_all == 'true' && (needs.detect-changes.outputs.docker_changed == 'true' || github.event.inputs.force_deploy_all == 'true')
    steps:
      - name: ğŸš€ å…¨é‡éƒ¨ç½²æ‰€æœ‰æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸš€ å…¨é‡éƒ¨ç½²æ‰€æœ‰æœåŠ¡..."
            
            # ç¡®ä¿ Docker ç¯å¢ƒæ˜¯æœ€æ–°ç‰ˆæœ¬
            echo "ğŸ³ æ£€æŸ¥å¹¶æ›´æ–° Docker ç¯å¢ƒ..."
            if ! command -v docker &> /dev/null || ! docker compose version &> /dev/null; then
              echo "ğŸš€ Docker æˆ– Docker Compose V2 æœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…/æ›´æ–°..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
              echo "âœ… Docker ç¯å¢ƒæ›´æ–°å®Œæˆï¼Œè¯·é‡æ–°ç™»å½•ä»¥ä½¿ç”¨æˆ·ç»„ç”Ÿæ•ˆæˆ–åœ¨åç»­å‘½ä»¤ä¸­ä½¿ç”¨ 'newgrp docker'"
            else
              echo "âœ… Docker ç¯å¢ƒå·²æ˜¯æœ€æ–°æˆ–å·²å®‰è£… Compose V2."
            fi

            cd /opt/gin-vue-admin
            
            # æ£€æŸ¥å¹¶åˆ›å»º/å¯ç”¨ Swap äº¤æ¢ç©ºé—´
            if [ "$(sudo swapon --show | wc -l)" -lt 2 ]; then
              echo "ğŸ¤” æœªå‘ç°Swap, æ­£åœ¨åˆ›å»º4GB Swapç©ºé—´..."
              sudo fallocate -l 4G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
              echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
              echo "âœ… Swapåˆ›å»ºå¹¶å¯ç”¨æˆåŠŸ!"
            else
              echo "âœ… Swapå·²å­˜åœ¨."
            fi
            sudo swapon --show

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ è·å–æœ€æ–°ä»£ç å¹¶å¼ºåˆ¶è¦†ç›–æœ¬åœ°..."
            git fetch origin
            git reset --hard origin/dev-mqtt
            
            # æ¸…ç†Dockeræ„å»ºç¼“å­˜
            docker builder prune -f || true

            # åˆ›å»ºå‰ç«¯ç¯å¢ƒé…ç½®æ–‡ä»¶
            echo "ğŸ“ åˆ›å»ºå‰ç«¯ç”Ÿäº§ç¯å¢ƒé…ç½®..."
            cat > web/.env.production << EOF
            VITE_CLI_PORT = 80
            VITE_SERVER_PORT = 8888
            VITE_BASE_API = '/api'
            VITE_BASE_PATH = ''
            VITE_EDITOR = vscode
            VITE_POSITION = open
            EOF
            
            # åœæ­¢æ‰€æœ‰æœåŠ¡
            echo "â¹ï¸ åœæ­¢æ—§æœåŠ¡..."
            docker compose -f deploy/docker-compose.yml down
            
            # é‡å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
            echo "ğŸ”¨ é‡å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡..."
            docker compose -f deploy/docker-compose.yml up -d --build --no-cache
            
            # å…¨é¢å¥åº·æ£€æŸ¥
            echo "ğŸ¥ å…¨é¢æœåŠ¡å¥åº·æ£€æŸ¥..."
            sleep 60
            
            # æ£€æŸ¥å‰ç«¯
            if curl -f -s http://localhost:80 > /dev/null; then
                echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
            else
                echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
            fi
            
            # æ£€æŸ¥åç«¯
            if curl -f -s http://localhost:8888/health > /dev/null; then
                echo "âœ… åç«¯æœåŠ¡æ­£å¸¸"
            else
                echo "âŒ åç«¯æœåŠ¡å¼‚å¸¸"
                docker compose -f deploy/docker-compose.yml logs --tail=30 backend
            fi

  # éƒ¨ç½²çŠ¶æ€é€šçŸ¥
  notify:
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-backend, deploy-frontend, deploy-all]
    if: always()
    steps:
      - name: ğŸ“¢ éƒ¨ç½²ç»“æœé€šçŸ¥
        run: |
          echo "ğŸ¯ æ™ºèƒ½éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“‹ å˜åŒ–æ£€æµ‹ç»“æœï¼š"
          echo "  - åç«¯å˜åŒ–: ${{ needs.detect-changes.outputs.backend_changed }}"
          echo "  - å‰ç«¯å˜åŒ–: ${{ needs.detect-changes.outputs.frontend_changed }}"
          echo "  - Dockerå˜åŒ–: ${{ needs.detect-changes.outputs.docker_changed }}"
          echo "  - å…¨é‡éƒ¨ç½²: ${{ needs.detect-changes.outputs.deploy_all }}"
          
          echo "ğŸš€ éƒ¨ç½²æ‰§è¡Œæƒ…å†µï¼š"
          if [[ "${{ needs.deploy-backend.result }}" == "success" ]]; then
            echo "  âœ… åç«¯æœåŠ¡éƒ¨ç½²æˆåŠŸ"
          elif [[ "${{ needs.deploy-backend.result }}" == "skipped" ]]; then
            echo "  â­ï¸ åç«¯æœåŠ¡è·³è¿‡éƒ¨ç½²ï¼ˆæ— å˜åŒ–ï¼‰"
          elif [[ "${{ needs.deploy-backend.result }}" == "failure" ]]; then
            echo "  âŒ åç«¯æœåŠ¡éƒ¨ç½²å¤±è´¥"
          fi
          
          if [[ "${{ needs.deploy-frontend.result }}" == "success" ]]; then
            echo "  âœ… å‰ç«¯æœåŠ¡éƒ¨ç½²æˆåŠŸ"
          elif [[ "${{ needs.deploy-frontend.result }}" == "skipped" ]]; then
            echo "  â­ï¸ å‰ç«¯æœåŠ¡è·³è¿‡éƒ¨ç½²ï¼ˆæ— å˜åŒ–ï¼‰"
          elif [[ "${{ needs.deploy-frontend.result }}" == "failure" ]]; then
            echo "  âŒ å‰ç«¯æœåŠ¡éƒ¨ç½²å¤±è´¥"
          fi
          
          if [[ "${{ needs.deploy-all.result }}" == "success" ]]; then
            echo "  âœ… å…¨é‡éƒ¨ç½²æˆåŠŸ"
          elif [[ "${{ needs.deploy-all.result }}" == "skipped" ]]; then
            echo "  â­ï¸ å…¨é‡éƒ¨ç½²è·³è¿‡"
          elif [[ "${{ needs.deploy-all.result }}" == "failure" ]]; then
            echo "  âŒ å…¨é‡éƒ¨ç½²å¤±è´¥"
          fi 
name: ğŸš¨ Emergency Fix - ç´§æ€¥ä¿®å¤å‰åç«¯é—®é¢˜

on:
  workflow_dispatch:
    inputs:
      fix_type:
        description: 'ä¿®å¤ç±»å‹'
        required: true
        default: 'frontend'
        type: choice
        options:
          - frontend
          - backend  
          - both

jobs:
  emergency-fix:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš¨ ç´§æ€¥ä¿®å¤ç³»ç»Ÿ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸš¨ å¼€å§‹ç´§æ€¥ä¿®å¤..."
            echo "ğŸ”§ ä¿®å¤ç±»å‹: ${{ github.event.inputs.fix_type }}"
            
            cd /opt/gin-vue-admin
            
            # æ‹‰å–æœ€æ–°ä¿®å¤ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä¿®å¤ä»£ç å¹¶å¼ºåˆ¶è¦†ç›–..."
            git fetch origin
            git reset --hard origin/dev-mqtt
            
            # åˆ›å»ºå®Œæ•´çš„å‰ç«¯ç¯å¢ƒé…ç½®
            echo "ğŸ“ åˆ›å»ºå‰ç«¯ç¯å¢ƒé…ç½®..."
            cat > web/.env.production << 'EOF'
            VITE_CLI_PORT = 80
            VITE_SERVER_PORT = 8888
            VITE_BASE_API = '/api'
            VITE_BASE_PATH = ''
            VITE_EDITOR = vscode
            VITE_POSITION = open
            NODE_ENV = production
            EOF
            
            # æ ¹æ®ä¿®å¤ç±»å‹æ‰§è¡Œå¯¹åº”æ“ä½œ
            if [[ "${{ github.event.inputs.fix_type }}" == "frontend" || "${{ github.event.inputs.fix_type }}" == "both" ]]; then
              echo "ğŸ¨ ä¿®å¤å‰ç«¯æœåŠ¡..."
              
              # åœæ­¢å‰ç«¯æœåŠ¡
              docker-compose -f deploy/docker-compose.yml stop frontend || true
              
              # åˆ é™¤å‰ç«¯é•œåƒå’Œå®¹å™¨
              docker rmi gin-vue-admin-frontend:latest || true
              docker container prune -f || true
              
              # æ¸…ç†Dockeræ„å»ºç¼“å­˜
              docker builder prune -f || true
              
              # è®¾ç½®Dockeræ„å»ºç¯å¢ƒå˜é‡
              export DOCKER_BUILDKIT=1
              export BUILDKIT_PROGRESS=plain
              
              # é‡æ–°æ„å»ºå‰ç«¯ï¼ˆé™åˆ¶å†…å­˜ä½¿ç”¨ï¼‰
              echo "ğŸ”¨ é‡æ–°æ„å»ºå‰ç«¯é•œåƒï¼ˆä¼˜åŒ–å†…å­˜ä½¿ç”¨ï¼‰..."
              docker-compose -f deploy/docker-compose.yml build --no-cache frontend
              
              # å¯åŠ¨å‰ç«¯æœåŠ¡
              echo "ğŸš€ å¯åŠ¨å‰ç«¯æœåŠ¡..."
              docker-compose -f deploy/docker-compose.yml up -d frontend
              
              # å‰ç«¯å¥åº·æ£€æŸ¥
              echo "ğŸ¥ å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥..."
              for i in {1..20}; do
                  if curl -f -s http://localhost:80 > /dev/null 2>&1; then
                      echo "âœ… å‰ç«¯æœåŠ¡ä¿®å¤æˆåŠŸï¼"
                      break
                  fi
                  if [ $i -eq 20 ]; then
                      echo "âŒ å‰ç«¯æœåŠ¡ä»æœ‰é—®é¢˜"
                      docker-compose -f deploy/docker-compose.yml logs --tail=30 frontend
                  fi
                  echo "â³ ç­‰å¾…å‰ç«¯æœåŠ¡... ($i/20)"
                  sleep 3
              done
            fi
            
            if [[ "${{ github.event.inputs.fix_type }}" == "backend" || "${{ github.event.inputs.fix_type }}" == "both" ]]; then
              echo "ğŸ”§ ä¿®å¤åç«¯æœåŠ¡..."
              
              # åœæ­¢åç«¯æœåŠ¡
              docker-compose -f deploy/docker-compose.yml stop backend || true
              
              # é‡æ–°æ„å»ºåç«¯
              echo "ğŸ”¨ é‡æ–°æ„å»ºåç«¯é•œåƒ..."
              docker-compose -f deploy/docker-compose.yml build --no-cache backend
              
              # å¯åŠ¨åç«¯æœåŠ¡
              echo "ğŸš€ å¯åŠ¨åç«¯æœåŠ¡..."
              docker-compose -f deploy/docker-compose.yml up -d backend
              
              # åç«¯å¥åº·æ£€æŸ¥
              echo "ğŸ¥ åç«¯æœåŠ¡å¥åº·æ£€æŸ¥..."
              for i in {1..30}; do
                  if curl -f -s http://localhost:8888/health > /dev/null 2>&1; then
                      echo "âœ… åç«¯æœåŠ¡ä¿®å¤æˆåŠŸï¼"
                      break
                  fi
                  if [ $i -eq 30 ]; then
                      echo "âŒ åç«¯æœåŠ¡ä»æœ‰é—®é¢˜"
                      docker-compose -f deploy/docker-compose.yml logs --tail=30 backend
                  fi
                  echo "â³ ç­‰å¾…åç«¯æœåŠ¡... ($i/30)"
                  sleep 3
              done
            fi
            
            echo "ğŸ“Š æœ€ç»ˆæœåŠ¡çŠ¶æ€ï¼š"
            docker-compose -f deploy/docker-compose.yml ps
            
            echo "ğŸ‰ ç´§æ€¥ä¿®å¤å®Œæˆï¼"
            echo "ğŸ“± å‰ç«¯åœ°å€: http://43.165.186.134"
            echo "ğŸ”§ åç«¯API: http://43.165.186.134/api"
            echo "ğŸ¥ åç«¯å¥åº·: http://43.165.186.134:8888/health" 
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT JWT æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin-bottom: 30px;
        }
        .step h2 {
            color: #007bff;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .token-display {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
            white-space: pre-wrap;
        }
        .jwt-payload {
            background-color: #e7f3ff;
            border: 1px solid #b8daff;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.online {
            background-color: #d4edda;
            color: #155724;
        }
        .status.offline {
            background-color: #f8d7da;
            color: #721c24;
        }
        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .info-table th, .info-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .info-table th {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <h1>ğŸ” MQTT JWT åŒTokenè®¤è¯ç³»ç»Ÿæµ‹è¯•</h1>
    
    <!-- æ­¥éª¤1: ç”¨æˆ·ç™»å½• -->
    <div class="container">
        <div class="step">
            <h2>æ­¥éª¤1: ç”¨æˆ·ç™»å½•è·å–API JWT</h2>
            <div class="form-group">
                <label for="serverUrl">æœåŠ¡å™¨åœ°å€:</label>
                <input type="text" id="serverUrl" value="http://localhost:8888" placeholder="ä¾‹å¦‚: http://localhost:8888">
            </div>
            <div class="form-group">
                <label for="username">ç”¨æˆ·å:</label>
                <input type="text" id="username" value="admin" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label for="password">å¯†ç :</label>
                <input type="password" id="password" value="123456" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            <div class="form-group">
                <label for="captcha">éªŒè¯ç :</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="captcha" placeholder="è¯·è¾“å…¥éªŒè¯ç " style="flex: 1;">
                    <img id="captchaImg" src="" alt="éªŒè¯ç " style="height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" onclick="getCaptcha()">
                    <button type="button" onclick="getCaptcha()" style="padding: 8px 12px;">åˆ·æ–°</button>
                </div>
                <input type="hidden" id="captchaId" value="">
            </div>
            <button onclick="getCaptcha()">è·å–éªŒè¯ç </button>
            <button onclick="login()">ç™»å½•</button>
            <div id="loginResult"></div>
            
            <div id="apiJwtInfo" style="display: none;">
                <h4>API JWT ä¿¡æ¯:</h4>
                <table class="info-table">
                    <tr><th>å­—æ®µ</th><th>å€¼</th></tr>
                    <tr><td>API JWT Token</td><td id="apiToken" class="token-display"></td></tr>
                    <tr><td>ç”¨æˆ·ID</td><td id="userId"></td></tr>
                    <tr><td>å®¢æˆ·ç«¯ID</td><td id="apiClientId"></td></tr>
                    <tr><td>è¿‡æœŸæ—¶é—´</td><td id="apiExpiresIn"></td></tr>
                </table>
            </div>
        </div>
    </div>

    <!-- æ­¥éª¤2: ç”ŸæˆMQTT JWT -->
    <div class="container">
        <div class="step">
            <h2>æ­¥éª¤2: ç”ŸæˆMQTTä¸“ç”¨JWT</h2>
            <div class="form-group">
                <label for="role">é€‰æ‹©è§’è‰²:</label>
                <select id="role">
                    <option value="transmitter">ä¼ å¡ç«¯ (transmitter)</option>
                    <option value="receiver">æ”¶å¡ç«¯ (receiver)</option>
                    <option value="admin">ç®¡ç†å‘˜ (admin)</option>
                </select>
            </div>
            <button onclick="generateMQTTToken()" id="generateBtn" disabled>ç”ŸæˆMQTT JWT</button>
            <div id="mqttTokenResult"></div>
            
            <div id="mqttJwtInfo" style="display: none;">
                <h4>MQTT JWT ä¿¡æ¯:</h4>
                <table class="info-table">
                    <tr><th>å­—æ®µ</th><th>å€¼</th></tr>
                    <tr><td>MQTT JWT Token</td><td id="mqttToken" class="token-display"></td></tr>
                    <tr><td>MQTT ClientID</td><td id="mqttClientId"></td></tr>
                    <tr><td>è§’è‰²</td><td id="mqttRole"></td></tr>
                    <tr><td>åºå·</td><td id="mqttSequence"></td></tr>
                    <tr><td>è¿‡æœŸæ—¶é—´</td><td id="mqttExpiresAt"></td></tr>
                </table>
            </div>
        </div>
    </div>

    <!-- æ­¥éª¤3: JWTè§£æ -->
    <div class="container">
        <div class="step">
            <h2>æ­¥éª¤3: MQTT JWT è§£æç»“æœ</h2>
            <button onclick="parseJWT()" id="parseBtn" disabled>è§£æMQTT JWT</button>
            <div id="jwtParseResult"></div>
            
            <div id="jwtPayloadInfo" style="display: none;">
                <h4>JWT Payload å†…å®¹:</h4>
                <div id="jwtPayload" class="jwt-payload"></div>
                
                <h4>è¯¦ç»†å­—æ®µè¯´æ˜:</h4>
                <table class="info-table">
                    <tr><th>å­—æ®µå</th><th>å«ä¹‰</th><th>å€¼</th></tr>
                    <tr><td>user_id</td><td>ç”¨æˆ·UUID</td><td id="payload_user_id"></td></tr>
                    <tr><td>username</td><td>ç”¨æˆ·å</td><td id="payload_username"></td></tr>
                    <tr><td>role</td><td>è§’è‰²</td><td id="payload_role"></td></tr>
                    <tr><td>client_id</td><td>MQTT ClientID</td><td id="payload_client_id"></td></tr>
                    <tr><td>sequence</td><td>è¿æ¥åºå·</td><td id="payload_sequence"></td></tr>
                    <tr><td>jti</td><td>JWTå”¯ä¸€æ ‡è¯†</td><td id="payload_jti"></td></tr>
                    <tr><td>iss</td><td>ç­¾å‘è€…</td><td id="payload_iss"></td></tr>
                    <tr><td>aud</td><td>å—ä¼—</td><td id="payload_aud"></td></tr>
                    <tr><td>exp</td><td>è¿‡æœŸæ—¶é—´</td><td id="payload_exp"></td></tr>
                    <tr><td>nbf</td><td>ç”Ÿæ•ˆæ—¶é—´</td><td id="payload_nbf"></td></tr>
                    <tr><td>iat</td><td>ç­¾å‘æ—¶é—´</td><td id="payload_iat"></td></tr>
                </table>
            </div>
        </div>
    </div>

    <!-- æ­¥éª¤4: MQTTè¿æ¥å‚æ•° -->
    <div class="container">
        <div class="step">
            <h2>æ­¥éª¤4: MQTTè¿æ¥å‚æ•°</h2>
            <div id="mqttConnectionInfo" style="display: none;">
                <h4>ğŸ”— å®¢æˆ·ç«¯MQTTè¿æ¥å‚æ•°:</h4>
                <table class="info-table">
                    <tr><th>å‚æ•°</th><th>å€¼</th><th>è¯´æ˜</th></tr>
                    <tr><td>Broker URL</td><td>mqtts://your-emqx-broker.com:8883</td><td>MQTTæœåŠ¡å™¨åœ°å€(éœ€è¦MQTTS)</td></tr>
                    <tr><td>Client ID</td><td id="conn_client_id" style="font-weight:bold;color:#007bff;"></td><td>åè®®çº§åˆ«çš„ClientID</td></tr>
                    <tr><td>Username</td><td id="conn_username" style="font-weight:bold;color:#007bff;"></td><td>è®¤è¯ç”¨æˆ·å(ä½¿ç”¨ClientID)</td></tr>
                    <tr><td>Password</td><td id="conn_password" style="font-family:monospace;font-size:10px;word-break:break-all;"></td><td>è®¤è¯å¯†ç (ä½¿ç”¨MQTT JWT)</td></tr>
                    <tr><td>Clean Session</td><td>true</td><td>æ¸…é™¤ä¼šè¯</td></tr>
                    <tr><td>MQTT Version</td><td>v5</td><td>æ¨èä½¿ç”¨MQTT v5</td></tr>
                </table>
                
                <h4>ğŸ“ JavaScript MQTTè¿æ¥ç¤ºä¾‹ä»£ç :</h4>
                <div class="token-display" id="mqttCodeExample"></div>
            </div>
        </div>
    </div>

    <!-- æ­¥éª¤5: MQTTè¿æ¥æµ‹è¯• -->
    <div class="container">
        <div class="step">
            <h2>æ­¥éª¤5: MQTTè¿æ¥æµ‹è¯•</h2>
            <div class="form-group">
                <label for="mqttBrokerUrl">MQTT Brokeråœ°å€:</label>
                <input type="text" id="mqttBrokerUrl" value="ws://localhost:8083/mqtt" placeholder="ä¾‹å¦‚: ws://localhost:8083/mqtt">
            </div>
            <button onclick="testMQTTConnection()" id="mqttTestBtn" disabled>æµ‹è¯•MQTTè¿æ¥</button>
            <button onclick="disconnectMQTT()" id="mqttDisconnectBtn" disabled>æ–­å¼€è¿æ¥</button>
            <div id="mqttTestResult"></div>
            
            <div id="mqttStatus" style="display: none;">
                <h4>MQTTè¿æ¥çŠ¶æ€:</h4>
                <div id="connectionStatus" class="status offline">ç¦»çº¿</div>
                
                <h4>æ¶ˆæ¯å‘å¸ƒæµ‹è¯•:</h4>
                <div class="form-group">
                    <label for="testTopic">æµ‹è¯•ä¸»é¢˜:</label>
                    <input type="text" id="testTopic" value="" placeholder="ä¾‹å¦‚: client/your-client-id/test">
                </div>
                <div class="form-group">
                    <label for="testMessage">æµ‹è¯•æ¶ˆæ¯:</label>
                    <textarea id="testMessage" rows="3" placeholder='{"message": "Hello MQTT!", "timestamp": "2024-01-01T00:00:00Z"}'></textarea>
                </div>
                <button onclick="publishMessage()">å‘å¸ƒæ¶ˆæ¯</button>
                
                <h4>æ¥æ”¶åˆ°çš„æ¶ˆæ¯:</h4>
                <div id="receivedMessages" class="token-display" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- æ­¥éª¤6: ç®¡ç†åŠŸèƒ½ -->
    <div class="container">
        <div class="step">
            <h2>æ­¥éª¤6: ç®¡ç†åŠŸèƒ½æµ‹è¯•</h2>
            <button onclick="getUserMQTTTokens()" id="getTokensBtn" disabled>è·å–ç”¨æˆ·æ‰€æœ‰MQTT Token</button>
            <button onclick="revokeMQTTToken()" id="revokeBtn" disabled>æ’¤é”€å½“å‰MQTT Token</button>
            <div id="managementResult"></div>
        </div>
    </div>

    <!-- å¼•å…¥MQTT.jsåº“ -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <script>
        let apiJWT = '';
        let mqttJWT = '';
        let currentMQTTClientID = '';
        let serverUrl = '';
        let mqttClient = null;
        let receivedMessageCount = 0;

        // è·å–éªŒè¯ç 
        async function getCaptcha() {
            serverUrl = document.getElementById('serverUrl').value;
            if (!serverUrl) {
                showResult('loginResult', 'è¯·å…ˆå¡«å†™æœåŠ¡å™¨åœ°å€', 'error');
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/base/captcha`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    document.getElementById('captchaImg').src = data.data.picPath;
                    document.getElementById('captchaId').value = data.data.captchaId;
                    showResult('loginResult', 'âœ… éªŒè¯ç è·å–æˆåŠŸï¼', 'success');
                } else {
                    showResult('loginResult', `âŒ éªŒè¯ç è·å–å¤±è´¥: ${data.msg}`, 'error');
                }
            } catch (error) {
                showResult('loginResult', `âŒ éªŒè¯ç è·å–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ­¥éª¤1: ç”¨æˆ·ç™»å½•
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const captcha = document.getElementById('captcha').value;
            const captchaId = document.getElementById('captchaId').value;
            serverUrl = document.getElementById('serverUrl').value;
            
            if (!username || !password || !serverUrl || !captcha || !captchaId) {
                showResult('loginResult', 'è¯·å¡«å†™å®Œæ•´çš„ç™»å½•ä¿¡æ¯å’ŒéªŒè¯ç ', 'error');
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/base/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        captcha: captcha,
                        captchaId: captchaId
                    })
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    apiJWT = data.data.token;
                    showResult('loginResult', 'âœ… ç™»å½•æˆåŠŸï¼', 'success');
                    
                    // æ˜¾ç¤ºAPI JWTä¿¡æ¯
                    document.getElementById('apiToken').textContent = apiJWT;
                    document.getElementById('userId').textContent = data.data.user.uuid || 'N/A';
                    document.getElementById('apiClientId').textContent = 'APIä¼šè¯ID';
                    document.getElementById('apiExpiresIn').textContent = data.data.expiresAt || 'N/A';
                    document.getElementById('apiJwtInfo').style.display = 'block';
                    
                    // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
                    document.getElementById('generateBtn').disabled = false;
                } else {
                    showResult('loginResult', `âŒ ç™»å½•å¤±è´¥: ${data.msg}`, 'error');
                }
            } catch (error) {
                showResult('loginResult', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ­¥éª¤2: ç”ŸæˆMQTT JWT
        async function generateMQTTToken() {
            const role = document.getElementById('role').value;
            
            if (!apiJWT) {
                showResult('mqttTokenResult', 'âŒ è¯·å…ˆç™»å½•è·å–API JWT', 'error');
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/jwt/generateMQTTToken`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-token': apiJWT,
                        'Authorization': `Bearer ${apiJWT}`
                    },
                    body: JSON.stringify({
                        role: role
                    })
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    mqttJWT = data.data.token;
                    currentMQTTClientID = data.data.client_id;
                    
                    showResult('mqttTokenResult', 'âœ… MQTT JWTç”ŸæˆæˆåŠŸï¼', 'success');
                    
                    // æ˜¾ç¤ºMQTT JWTä¿¡æ¯
                    document.getElementById('mqttToken').textContent = mqttJWT;
                    document.getElementById('mqttClientId').textContent = data.data.client_id;
                    document.getElementById('mqttRole').textContent = data.data.role;
                    document.getElementById('mqttSequence').textContent = data.data.sequence;
                    document.getElementById('mqttExpiresAt').textContent = new Date(data.data.expires_at * 1000).toLocaleString();
                    document.getElementById('mqttJwtInfo').style.display = 'block';
                    
                                         // å¯ç”¨è§£æå’Œç®¡ç†æŒ‰é’®
                     document.getElementById('parseBtn').disabled = false;
                     document.getElementById('mqttTestBtn').disabled = false;
                     document.getElementById('getTokensBtn').disabled = false;
                     document.getElementById('revokeBtn').disabled = false;
                } else {
                    showResult('mqttTokenResult', `âŒ ç”Ÿæˆå¤±è´¥: ${data.msg}`, 'error');
                }
            } catch (error) {
                showResult('mqttTokenResult', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ­¥éª¤3: è§£æJWT
        function parseJWT() {
            if (!mqttJWT) {
                showResult('jwtParseResult', 'âŒ è¯·å…ˆç”ŸæˆMQTT JWT', 'error');
                return;
            }

            try {
                // è§£æJWT (æ³¨æ„ï¼šè¿™åªæ˜¯å‰ç«¯è§£æï¼Œä¸éªŒè¯ç­¾å)
                const parts = mqttJWT.split('.');
                if (parts.length !== 3) {
                    throw new Error('æ— æ•ˆçš„JWTæ ¼å¼');
                }

                const header = JSON.parse(atob(parts[0]));
                const payload = JSON.parse(atob(parts[1]));

                showResult('jwtParseResult', 'âœ… JWTè§£ææˆåŠŸï¼', 'success');

                // æ˜¾ç¤ºå®Œæ•´payload
                document.getElementById('jwtPayload').textContent = JSON.stringify(payload, null, 2);

                // å¡«å……è¯¦ç»†å­—æ®µ
                document.getElementById('payload_user_id').textContent = payload.user_id || 'N/A';
                document.getElementById('payload_username').textContent = payload.username || 'N/A';
                document.getElementById('payload_role').textContent = payload.role || 'N/A';
                document.getElementById('payload_client_id').textContent = payload.client_id || 'N/A';
                document.getElementById('payload_sequence').textContent = payload.sequence || 'N/A';
                document.getElementById('payload_jti').textContent = payload.jti || 'N/A';
                document.getElementById('payload_iss').textContent = payload.iss || 'N/A';
                document.getElementById('payload_aud').textContent = JSON.stringify(payload.aud) || 'N/A';
                document.getElementById('payload_exp').textContent = payload.exp ? new Date(payload.exp * 1000).toLocaleString() : 'N/A';
                document.getElementById('payload_nbf').textContent = payload.nbf ? new Date(payload.nbf * 1000).toLocaleString() : 'N/A';
                document.getElementById('payload_iat').textContent = payload.iat ? new Date(payload.iat * 1000).toLocaleString() : 'N/A';

                document.getElementById('jwtPayloadInfo').style.display = 'block';

                // æ˜¾ç¤ºMQTTè¿æ¥ä¿¡æ¯
                showMQTTConnectionInfo(payload);

            } catch (error) {
                showResult('jwtParseResult', `âŒ è§£æå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºMQTTè¿æ¥ä¿¡æ¯
        function showMQTTConnectionInfo(payload) {
            document.getElementById('conn_client_id').textContent = payload.client_id;
            document.getElementById('conn_username').textContent = payload.client_id;
            document.getElementById('conn_password').textContent = mqttJWT;

            // ç”Ÿæˆè¿æ¥ç¤ºä¾‹ä»£ç 
            const codeExample = `// MQTTè¿æ¥ç¤ºä¾‹ä»£ç 
const mqtt = require('mqtt');

const options = {
    clientId: '${payload.client_id}',     // MQTT ClientID
    username: '${payload.client_id}',     // Username (ä½¿ç”¨ClientID)
    password: '${mqttJWT.substring(0, 50)}...', // Password (MQTT JWT)
    clean: true,                          // Clean Session
    protocolVersion: 5                    // MQTT v5
};

const client = mqtt.connect('mqtts://your-emqx-broker.com:8883', options);

client.on('connect', () => {
    console.log('âœ… MQTTè¿æ¥æˆåŠŸ!');
    console.log('è§’è‰²:', '${payload.role}');
    console.log('ClientID:', '${payload.client_id}');
    
    // å‘å¸ƒä¸Šçº¿çŠ¶æ€
    client.publish('client/${payload.client_id}/status', JSON.stringify({
        online: true,
        timestamp: new Date().toISOString(),
        role: '${payload.role}'
    }));
});

client.on('error', (err) => {
    console.error('âŒ MQTTè¿æ¥å¤±è´¥:', err);
});`;

            document.getElementById('mqttCodeExample').textContent = codeExample;
            document.getElementById('mqttConnectionInfo').style.display = 'block';
        }

        // è·å–ç”¨æˆ·æ‰€æœ‰MQTT Token
        async function getUserMQTTTokens() {
            if (!apiJWT) {
                showResult('managementResult', 'âŒ è¯·å…ˆç™»å½•', 'error');
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/jwt/getUserMQTTTokens`, {
                    method: 'GET',
                    headers: {
                        'x-token': apiJWT,
                        'Authorization': `Bearer ${apiJWT}`
                    }
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    let result = 'âœ… è·å–æˆåŠŸï¼ç”¨æˆ·æ´»è·ƒçš„MQTTè¿æ¥:\\n\\n';
                    if (data.data && data.data.length > 0) {
                        data.data.forEach((token, index) => {
                            result += `${index + 1}. ClientID: ${token.client_id}\\n`;
                            result += `   è§’è‰²: ${token.role}\\n`;
                            result += `   åˆ›å»ºæ—¶é—´: ${token.created_at}\\n`;
                            result += `   JTI: ${token.jti}\\n\\n`;
                        });
                    } else {
                        result += 'æš‚æ— æ´»è·ƒçš„MQTTè¿æ¥';
                    }
                    showResult('managementResult', result, 'success');
                } else {
                    showResult('managementResult', `âŒ è·å–å¤±è´¥: ${data.msg}`, 'error');
                }
            } catch (error) {
                showResult('managementResult', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ’¤é”€MQTT Token
        async function revokeMQTTToken() {
            if (!apiJWT || !currentMQTTClientID) {
                showResult('managementResult', 'âŒ è¯·å…ˆç”ŸæˆMQTT JWT', 'error');
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/jwt/revokeMQTTToken`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-token': apiJWT,
                        'Authorization': `Bearer ${apiJWT}`
                    },
                    body: JSON.stringify({
                        client_id: currentMQTTClientID
                    })
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    showResult('managementResult', `âœ… æ’¤é”€æˆåŠŸï¼ClientID: ${currentMQTTClientID}`, 'success');
                } else {
                    showResult('managementResult', `âŒ æ’¤é”€å¤±è´¥: ${data.msg}`, 'error');
                }
            } catch (error) {
                showResult('managementResult', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºç»“æœçš„è¾…åŠ©å‡½æ•°
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }

                 // MQTTè¿æ¥æµ‹è¯•
         async function testMQTTConnection() {
             if (!mqttJWT || !currentMQTTClientID) {
                 showResult('mqttTestResult', 'âŒ è¯·å…ˆç”ŸæˆMQTT JWT', 'error');
                 return;
             }

             const brokerUrl = document.getElementById('mqttBrokerUrl').value;
             if (!brokerUrl) {
                 showResult('mqttTestResult', 'âŒ è¯·å¡«å†™MQTT Brokeråœ°å€', 'error');
                 return;
             }

             try {
                 // è§£æJWTè·å–payload
                 const payload = JSON.parse(atob(mqttJWT.split('.')[1]));
                 
                 showResult('mqttTestResult', 'ğŸ”„ æ­£åœ¨è¿æ¥MQTT Broker...', 'success');

                 const options = {
                     clientId: currentMQTTClientID,
                     username: currentMQTTClientID,
                     password: mqttJWT,
                     clean: true,
                     connectTimeout: 10000,
                     reconnectPeriod: 0 // ç¦ç”¨è‡ªåŠ¨é‡è¿ï¼Œä¾¿äºæµ‹è¯•
                 };

                 mqttClient = mqtt.connect(brokerUrl, options);

                 mqttClient.on('connect', () => {
                     showResult('mqttTestResult', 'âœ… MQTTè¿æ¥æˆåŠŸï¼', 'success');
                     document.getElementById('connectionStatus').textContent = 'åœ¨çº¿';
                     document.getElementById('connectionStatus').className = 'status online';
                     document.getElementById('mqttStatus').style.display = 'block';
                     document.getElementById('mqttDisconnectBtn').disabled = false;
                     
                     // è®¾ç½®é»˜è®¤æµ‹è¯•ä¸»é¢˜
                     document.getElementById('testTopic').value = `client/${currentMQTTClientID}/test`;
                     document.getElementById('testMessage').value = JSON.stringify({
                         message: "Hello MQTT!",
                         timestamp: new Date().toISOString(),
                         role: payload.role,
                         clientId: currentMQTTClientID
                     }, null, 2);

                     // è®¢é˜…ä¸€äº›æµ‹è¯•ä¸»é¢˜
                     mqttClient.subscribe(`client/${currentMQTTClientID}/+`);
                     mqttClient.subscribe(`broadcast/+`);
                     
                     addReceivedMessage(`âœ… è¿æ¥æˆåŠŸ! è§’è‰²: ${payload.role}, ClientID: ${currentMQTTClientID}`);
                 });

                 mqttClient.on('error', (error) => {
                     showResult('mqttTestResult', `âŒ MQTTè¿æ¥å¤±è´¥: ${error.message}`, 'error');
                     document.getElementById('connectionStatus').textContent = 'ç¦»çº¿';
                     document.getElementById('connectionStatus').className = 'status offline';
                 });

                 mqttClient.on('close', () => {
                     showResult('mqttTestResult', 'ğŸ”Œ MQTTè¿æ¥å·²æ–­å¼€', 'success');
                     document.getElementById('connectionStatus').textContent = 'ç¦»çº¿';
                     document.getElementById('connectionStatus').className = 'status offline';
                     document.getElementById('mqttDisconnectBtn').disabled = true;
                 });

                 mqttClient.on('message', (topic, message) => {
                     try {
                         const messageStr = message.toString();
                         addReceivedMessage(`ğŸ“¨ [${topic}] ${messageStr}`);
                     } catch (error) {
                         addReceivedMessage(`ğŸ“¨ [${topic}] ${message.toString()}`);
                     }
                 });

             } catch (error) {
                 showResult('mqttTestResult', `âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
             }
         }

         // æ–­å¼€MQTTè¿æ¥
         function disconnectMQTT() {
             if (mqttClient) {
                 mqttClient.end();
                 mqttClient = null;
                 document.getElementById('mqttStatus').style.display = 'none';
             }
         }

         // å‘å¸ƒæ¶ˆæ¯
         function publishMessage() {
             if (!mqttClient || !mqttClient.connected) {
                 alert('âŒ MQTTæœªè¿æ¥');
                 return;
             }

             const topic = document.getElementById('testTopic').value;
             const message = document.getElementById('testMessage').value;

             if (!topic || !message) {
                 alert('âŒ è¯·å¡«å†™ä¸»é¢˜å’Œæ¶ˆæ¯å†…å®¹');
                 return;
             }

             try {
                 mqttClient.publish(topic, message);
                 addReceivedMessage(`ğŸ“¤ å‘å¸ƒæ¶ˆæ¯åˆ° [${topic}]: ${message}`);
             } catch (error) {
                 addReceivedMessage(`âŒ å‘å¸ƒå¤±è´¥: ${error.message}`);
             }
         }

         // æ·»åŠ æ¥æ”¶åˆ°çš„æ¶ˆæ¯
         function addReceivedMessage(message) {
             receivedMessageCount++;
             const messagesDiv = document.getElementById('receivedMessages');
             const timestamp = new Date().toLocaleTimeString();
             messagesDiv.innerHTML += `[${timestamp}] ${message}\n`;
             messagesDiv.scrollTop = messagesDiv.scrollHeight;
         }

         // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
         document.addEventListener('DOMContentLoaded', function() {
             console.log('ğŸ” MQTT JWT æµ‹è¯•é¡µé¢å·²åŠ è½½');
             console.log('è¯·æŒ‰ç…§æ­¥éª¤1â†’2â†’3â†’4â†’5â†’6çš„é¡ºåºè¿›è¡Œæµ‹è¯•');
             
             // é¡µé¢åŠ è½½æ—¶è·å–éªŒè¯ç 
             setTimeout(getCaptcha, 500);
         });
    </script>
</body>
</html> 
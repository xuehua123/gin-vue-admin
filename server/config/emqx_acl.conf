%%--------------------------------------------------------------------
%% EMQX ACL规则配置文件
%% 用途：安全卡片中继系统MQTT权限控制
%% 原则：最小权限原则，客户端只能访问client/{clientID}/...主题
%% 修订：支持服务器中继的设备间通信
%%--------------------------------------------------------------------

%%--------------------------------------------------------------------
%% 管理员权限 (服务器端组件)
%% 服务器端组件需要全局访问权限进行状态同步和事件处理
%%--------------------------------------------------------------------
% 服务器角色管理服务 - 订阅角色设置请求
{allow, {user, "server_role_manager"}, subscribe, ["client/+/control/set_role_request"]}.
{allow, {user, "server_role_manager"}, publish, ["client/+/control/set_role_response"]}.
{allow, {user, "server_role_manager"}, publish, ["client/+/control/role_revoked_notification"]}.
{allow, {user, "server_role_manager"}, publish, ["client/+/control/peer_status_notification"]}.

% 服务器状态同步服务 - 处理状态更新事件
{allow, {user, "server_state_sync"}, subscribe, ["client/+/event/state_update"]}.
{allow, {user, "server_state_sync"}, publish, ["client/+/sync/peer_state_update"]}.

% 服务器APDU中继服务 - 处理交易相关消息
{allow, {user, "server_apdu_relay"}, subscribe, ["client/+/transaction/+/apdu/up"]}.
{allow, {user, "server_apdu_relay"}, publish, ["client/+/transaction/+/apdu/down"]}.
{allow, {user, "server_apdu_relay"}, publish, ["client/+/control/transaction_started"]}.
{allow, {user, "server_apdu_relay"}, publish, ["client/+/control/transaction_ended"]}.

% 服务器监控服务 - 监控所有客户端状态
{allow, {user, "server_monitor"}, subscribe, ["client/+/status"]}.
{allow, {user, "server_monitor"}, subscribe, ["client/+/heartbeat"]}.

% 管理员 - 完全访问权限
{allow, {user, "admin"}, pubsub, ["#"]}.

%%--------------------------------------------------------------------
%% 客户端权限规则
%% 基于JWT Claims中的clientid字段进行细粒度权限控制
%% 注意：只允许客户端操作自己的主题
%%--------------------------------------------------------------------

%% 客户端发布权限 - 只能发布到自己的主题
% 允许客户端发布自己的在线状态
{allow, {clientid, "%c"}, publish, ["client/%c/status"]}.

% 允许客户端发布心跳消息
{allow, {clientid, "%c"}, publish, ["client/%c/heartbeat"]}.

% 允许客户端发布状态更新事件
{allow, {clientid, "%c"}, publish, ["client/%c/event/state_update"]}.

% 允许客户端发布角色设置请求
{allow, {clientid, "%c"}, publish, ["client/%c/control/set_role_request"]}.

% 允许客户端在交易期间发布APDU数据
{allow, {clientid, "%c"}, publish, ["client/%c/transaction/+/apdu/up"]}.

% 允许客户端发布交易控制消息
{allow, {clientid, "%c"}, publish, ["client/%c/transaction/+/control/abort"]}.
{allow, {clientid, "%c"}, publish, ["client/%c/transaction/+/control/complete"]}.

%% 客户端订阅权限 - 可以订阅自己的所有主题
% 允许客户端订阅控制指令（包括服务器发送的对端状态通知）
{allow, {clientid, "%c"}, subscribe, ["client/%c/control/#"]}.

% 允许客户端订阅状态同步消息（接收对端状态更新）
{allow, {clientid, "%c"}, subscribe, ["client/%c/sync/#"]}.

% 允许客户端订阅交易相关消息
{allow, {clientid, "%c"}, subscribe, ["client/%c/transaction/+/apdu/down"]}.

% 允许客户端订阅自己的状态主题（用于确认发布）
{allow, {clientid, "%c"}, subscribe, ["client/%c/status"]}.
{allow, {clientid, "%c"}, subscribe, ["client/%c/heartbeat"]}.

%%--------------------------------------------------------------------
%% 安全限制规则
%% 防止客户端未授权访问
%%--------------------------------------------------------------------
% 禁止客户端访问系统主题
{deny, all, pubsub, ["$SYS/#"]}.

%%--------------------------------------------------------------------
%% 默认拒绝规则
%% 除明确允许的主题外，其他所有访问都被拒绝
%% 这包括了对其他客户端主题的访问
%%--------------------------------------------------------------------
% 最后的默认拒绝规则 - 确保最小权限原则
{deny, all, pubsub, ["#"]}. 
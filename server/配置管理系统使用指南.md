# é…ç½®ç®¡ç†ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

é…ç½®ç®¡ç†ç³»ç»Ÿæ˜¯ä¸€ä¸ªå®Œæ•´çš„åŠ¨æ€é…ç½®ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œæä¾›ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

- ğŸ”„ **åŠ¨æ€é…ç½®çƒ­é‡è½½** - æ”¯æŒé…ç½®æ–‡ä»¶å®æ—¶ç›‘æ§å’Œè‡ªåŠ¨é‡è½½
- ğŸ“‹ **åˆè§„è§„åˆ™ç®¡ç†** - å®Œæ•´çš„åˆè§„è§„åˆ™CRUDæ“ä½œå’ŒéªŒè¯
- ğŸ“š **é…ç½®å˜æ›´å®¡è®¡** - è¯¦ç»†çš„é…ç½®å˜æ›´å†å²è®°å½•å’Œè¿½è¸ª
- ğŸ” **é…ç½®éªŒè¯** - è‡ªåŠ¨éªŒè¯é…ç½®æ–‡ä»¶çš„æ­£ç¡®æ€§å’Œå®Œæ•´æ€§
- ğŸ’¾ **è‡ªåŠ¨å¤‡ä»½** - é…ç½®å˜æ›´å‰è‡ªåŠ¨åˆ›å»ºå¤‡ä»½æ–‡ä»¶

## ç³»ç»Ÿæ¶æ„

```
é…ç½®ç®¡ç†ç³»ç»Ÿæ¶æ„
â”œâ”€â”€ æ ¸å¿ƒé…ç½®ç®¡ç†å™¨ (config/config_manager.go)
â”‚   â”œâ”€â”€ æ–‡ä»¶ç›‘æ§ (fsnotify)
â”‚   â”œâ”€â”€ çƒ­é‡è½½æœºåˆ¶
â”‚   â”œâ”€â”€ å¤‡ä»½ç³»ç»Ÿ
â”‚   â””â”€â”€ å˜æ›´å¤„ç†å™¨
â”œâ”€â”€ æœåŠ¡å±‚ (service/system/sys_config_manager.go)
â”‚   â”œâ”€â”€ åˆè§„è§„åˆ™CRUD
â”‚   â”œâ”€â”€ é…ç½®éªŒè¯
â”‚   â””â”€â”€ å®¡è®¡æ—¥å¿—
â”œâ”€â”€ APIå±‚ (api/v1/system/sys_config_manager.go)
â”‚   â”œâ”€â”€ RESTful APIæ¥å£
â”‚   â”œâ”€â”€ è¯·æ±‚éªŒè¯
â”‚   â””â”€â”€ é”™è¯¯å¤„ç†
â”œâ”€â”€ æ•°æ®å±‚ (model/system/)
â”‚   â”œâ”€â”€ è¯·æ±‚æ¨¡å‹
â”‚   â”œâ”€â”€ å“åº”æ¨¡å‹
â”‚   â””â”€â”€ æ•°æ®åº“æ¨¡å‹
â””â”€â”€ è·¯ç”±å±‚ (router/system/sys_config_manager.go)
    â”œâ”€â”€ è·¯ç”±æ³¨å†Œ
    â”œâ”€â”€ ä¸­é—´ä»¶é…ç½®
    â””â”€â”€ æƒé™æ§åˆ¶
```

## æ–‡ä»¶ç»“æ„

### æ ¸å¿ƒæ–‡ä»¶
- `config/config_manager.go` - æ ¸å¿ƒé…ç½®ç®¡ç†å™¨
- `config/compliance_rules.json` - åˆè§„è§„åˆ™é…ç½®æ–‡ä»¶
- `service/system/sys_config_manager.go` - é…ç½®ç®¡ç†æœåŠ¡
- `api/v1/system/sys_config_manager.go` - APIæ§åˆ¶å™¨
- `model/system/request/sys_config_manager.go` - è¯·æ±‚æ¨¡å‹
- `model/system/sys_config_change_history.go` - æ•°æ®æ¨¡å‹
- `router/system/sys_config_manager.go` - è·¯ç”±é…ç½®

### é…ç½®æ–‡ä»¶
- `config.yaml` - ä¸»é…ç½®æ–‡ä»¶
- `config/compliance_rules.json` - åˆè§„è§„åˆ™æ–‡ä»¶

### è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶
- `config_backups/` - é…ç½®å¤‡ä»½ç›®å½•
- `log/` - å®¡è®¡æ—¥å¿—ç›®å½•

## APIæ¥å£è¯´æ˜

### 1. åˆè§„è§„åˆ™ç®¡ç†

#### è·å–æ‰€æœ‰åˆè§„è§„åˆ™
```http
GET /api/configManager/complianceRules
```

#### è·å–åˆè§„è§„åˆ™åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
```http
GET /api/configManager/complianceRulesList?page=1&pageSize=10&category=transaction
```

#### è·å–å•ä¸ªåˆè§„è§„åˆ™
```http
GET /api/configManager/complianceRule/{rule_id}
```

#### åˆ›å»ºåˆè§„è§„åˆ™
```http
POST /api/configManager/complianceRule
Content-Type: application/json

{
  "id": "rule_001",
  "name": "äº¤æ˜“é‡‘é¢é™åˆ¶",
  "description": "æ£€æŸ¥å•ç¬”äº¤æ˜“é‡‘é¢æ˜¯å¦è¶…è¿‡é™åˆ¶",
  "category": "transaction",
  "severity": "high",
  "enabled": true,
  "conditions": [
    {
      "field": "amount",
      "operator": "greater_than",
      "value": 100000,
      "logic_op": "AND"
    }
  ],
  "actions": [
    {
      "type": "block",
      "parameters": {
        "reason": "äº¤æ˜“é‡‘é¢è¶…è¿‡é™åˆ¶"
      }
    }
  ]
}
```

#### æ›´æ–°åˆè§„è§„åˆ™
```http
PUT /api/configManager/complianceRule/{rule_id}
Content-Type: application/json

{
  "description": "æ›´æ–°åçš„æè¿°",
  "enabled": false
}
```

#### åˆ é™¤åˆè§„è§„åˆ™
```http
DELETE /api/configManager/complianceRule/{rule_id}
```

#### æ‰¹é‡æ›´æ–°åˆè§„è§„åˆ™
```http
POST /api/configManager/batchUpdateComplianceRules
Content-Type: application/json

{
  "operations": [
    {
      "operation": "update",
      "rule_id": "rule_001",
      "data": {
        "enabled": false
      }
    },
    {
      "operation": "delete",
      "rule_id": "rule_002"
    }
  ]
}
```

### 2. é…ç½®ç®¡ç†

#### é‡è½½ä¸»é…ç½®
```http
POST /api/configManager/reloadMainConfig
Content-Type: application/json

{
  "config_type": "main",
  "force": false
}
```

#### ä¿å­˜åˆè§„è§„åˆ™
```http
POST /api/configManager/saveComplianceRules
```

#### åŠ è½½åˆè§„è§„åˆ™
```http
POST /api/configManager/loadComplianceRules
```

#### éªŒè¯é…ç½®
```http
POST /api/configManager/validateConfig
Content-Type: application/json

{
  "config_types": ["main", "compliance_rules"]
}
```

### 3. å®¡è®¡å’Œå†å²

#### è·å–é…ç½®å˜æ›´å†å²
```http
GET /api/configManager/changeHistory?page=1&pageSize=10&config_type=compliance_rules&start_time=2024-01-01&end_time=2024-12-31
```

## ä½¿ç”¨ç¤ºä¾‹

### 1. åŸºæœ¬é…ç½®ç®¡ç†

```go
// è·å–é…ç½®ç®¡ç†æœåŠ¡
configManagerService := service.ServiceGroupApp.SystemServiceGroup.GetConfigManagerService()

// åˆå§‹åŒ–é…ç½®ç®¡ç†å™¨
err := configManagerService.InitializeConfigManager()
if err != nil {
    log.Fatal("é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:", err)
}

// è·å–åˆè§„è§„åˆ™
rules, err := configManagerService.GetComplianceRules()
if err != nil {
    log.Printf("è·å–åˆè§„è§„åˆ™å¤±è´¥: %v", err)
    return
}
```

### 2. åˆ›å»ºåˆè§„è§„åˆ™

```go
newRule := request.CreateComplianceRuleRequest{
    ID:          "custom_rule_001",
    Name:        "è‡ªå®šä¹‰è§„åˆ™",
    Description: "è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„åˆè§„è§„åˆ™",
    Category:    "security",
    Severity:    "medium",
    Enabled:     true,
    Conditions: []request.RuleConditionRequest{
        {
            Field:    "ip_address",
            Operator: "not_in",
            Value:    []string{"192.168.1.0/24"},
            LogicOp:  "AND",
        },
    },
    Actions: []request.RuleActionRequest{
        {
            Type: "audit_log",
            Parameters: map[string]interface{}{
                "level": "high",
            },
        },
    },
}

err := configManagerService.CreateComplianceRule(newRule)
if err != nil {
    log.Printf("åˆ›å»ºåˆè§„è§„åˆ™å¤±è´¥: %v", err)
}
```

### 3. é…ç½®çƒ­é‡è½½

```go
// é‡è½½ä¸»é…ç½®
err := configManagerService.ReloadMainConfig()
if err != nil {
    log.Printf("é‡è½½é…ç½®å¤±è´¥: %v", err)
}
```

### 4. é…ç½®éªŒè¯

```go
// éªŒè¯é…ç½®
result, err := configManagerService.ValidateConfiguration()
if err != nil {
    log.Printf("é…ç½®éªŒè¯å¤±è´¥: %v", err)
    return
}

if !result.IsValid {
    log.Printf("é…ç½®éªŒè¯å¤±è´¥ï¼Œé”™è¯¯: %v", result.Errors)
}
```

## åˆè§„è§„åˆ™é…ç½®

### è§„åˆ™ç»“æ„

```json
{
  "id": "è§„åˆ™å”¯ä¸€æ ‡è¯†",
  "name": "è§„åˆ™åç§°",
  "description": "è§„åˆ™æè¿°",
  "category": "è§„åˆ™ç±»åˆ« (transaction/behavior/security/compliance)",
  "severity": "ä¸¥é‡çº§åˆ« (low/medium/high/critical)",
  "enabled": true,
  "conditions": [
    {
      "field": "å­—æ®µå",
      "operator": "æ“ä½œç¬¦ (equals/greater_than/in/containsç­‰)",
      "value": "æ¯”è¾ƒå€¼",
      "logic_op": "é€»è¾‘æ“ä½œç¬¦ (AND/OR)"
    }
  ],
  "actions": [
    {
      "type": "åŠ¨ä½œç±»å‹ (block/warning/audit_log/notify/quarantine)",
      "parameters": {
        "å‚æ•°å": "å‚æ•°å€¼"
      }
    }
  ],
  "valid_from": "ç”Ÿæ•ˆæ—¶é—´(å¯é€‰)",
  "valid_until": "å¤±æ•ˆæ—¶é—´(å¯é€‰)",
  "metadata": {
    "created_by": "åˆ›å»ºè€…",
    "version": "ç‰ˆæœ¬å·"
  }
}
```

### æ”¯æŒçš„æ“ä½œç¬¦

- `equals` - ç­‰äº
- `not_equals` - ä¸ç­‰äº
- `greater_than` - å¤§äº
- `less_than` - å°äº
- `greater_equal` - å¤§äºç­‰äº
- `less_equal` - å°äºç­‰äº
- `in` - åŒ…å«åœ¨åˆ—è¡¨ä¸­
- `not_in` - ä¸åŒ…å«åœ¨åˆ—è¡¨ä¸­
- `contains` - åŒ…å«å­—ç¬¦ä¸²
- `not_contains` - ä¸åŒ…å«å­—ç¬¦ä¸²

### æ”¯æŒçš„åŠ¨ä½œç±»å‹

- `block` - é˜»æ­¢æ“ä½œ
- `warning` - å‘å‡ºè­¦å‘Š
- `audit_log` - è®°å½•å®¡è®¡æ—¥å¿—
- `notify` - å‘é€é€šçŸ¥
- `quarantine` - éš”ç¦»å¤„ç†

## ç›‘æ§å’Œæ—¥å¿—

### æ–‡ä»¶ç›‘æ§

ç³»ç»Ÿä¼šè‡ªåŠ¨ç›‘æ§ä»¥ä¸‹é…ç½®æ–‡ä»¶çš„å˜åŒ–ï¼š
- ä¸»é…ç½®æ–‡ä»¶ (`config.yaml`)
- åˆè§„è§„åˆ™æ–‡ä»¶ (`config/compliance_rules.json`)
- NFCä¸­ç»§é…ç½®æ–‡ä»¶
- å®‰å…¨é…ç½®æ–‡ä»¶

### å®¡è®¡æ—¥å¿—

æ‰€æœ‰é…ç½®å˜æ›´éƒ½ä¼šè®°å½•åˆ°å®¡è®¡æ—¥å¿—ï¼ŒåŒ…æ‹¬ï¼š
- å˜æ›´æ—¶é—´
- å˜æ›´ç±»å‹
- å˜æ›´å†…å®¹
- æ“ä½œç”¨æˆ·
- å˜æ›´å‰åçš„å€¼

### å¤‡ä»½æœºåˆ¶

- é…ç½®å˜æ›´å‰è‡ªåŠ¨åˆ›å»ºå¤‡ä»½
- å¤‡ä»½æ–‡ä»¶å‘½åæ ¼å¼ï¼š`åŸæ–‡ä»¶å.backup.æ—¶é—´æˆ³`
- å¤‡ä»½æ–‡ä»¶å­˜å‚¨åœ¨ `config_backups/` ç›®å½•
- æ”¯æŒæ‰‹åŠ¨æ¢å¤åˆ°ä»»æ„å¤‡ä»½ç‰ˆæœ¬

## é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯ç 

- `CONFIG_MANAGER_NOT_INITIALIZED` - é…ç½®ç®¡ç†å™¨æœªåˆå§‹åŒ–
- `COMPLIANCE_RULE_NOT_FOUND` - åˆè§„è§„åˆ™ä¸å­˜åœ¨
- `INVALID_RULE_FORMAT` - è§„åˆ™æ ¼å¼æ— æ•ˆ
- `CONFIG_VALIDATION_FAILED` - é…ç½®éªŒè¯å¤±è´¥
- `FILE_WATCH_ERROR` - æ–‡ä»¶ç›‘æ§é”™è¯¯

### é”™è¯¯å¤„ç†ç­–ç•¥

1. **é…ç½®æ–‡ä»¶æŸå** - è‡ªåŠ¨æ¢å¤åˆ°æœ€è¿‘çš„æœ‰æ•ˆå¤‡ä»½
2. **è§„åˆ™éªŒè¯å¤±è´¥** - è¿”å›è¯¦ç»†çš„éªŒè¯é”™è¯¯ä¿¡æ¯
3. **æ–‡ä»¶ç›‘æ§å¤±è´¥** - è®°å½•é”™è¯¯æ—¥å¿—å¹¶å°è¯•é‡æ–°åˆå§‹åŒ–
4. **æƒé™é—®é¢˜** - æä¾›æ¸…æ™°çš„æƒé™é”™è¯¯æç¤º

## æ€§èƒ½ä¼˜åŒ–

### é…ç½®ç¼“å­˜

- åˆè§„è§„åˆ™ç¼“å­˜åˆ°å†…å­˜ä¸­
- æ”¯æŒç¼“å­˜å¤±æ•ˆå’Œåˆ·æ–°
- å‡å°‘ç£ç›˜I/Oæ“ä½œ

### æ–‡ä»¶ç›‘æ§ä¼˜åŒ–

- ä½¿ç”¨é˜²æŠ–åŠ¨æœºåˆ¶é¿å…é¢‘ç¹é‡è½½
- æ‰¹é‡å¤„ç†æ–‡ä»¶å˜æ›´äº‹ä»¶
- å¼‚æ­¥å¤„ç†é…ç½®é‡è½½

### æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

- åˆ†é¡µæŸ¥è¯¢é…ç½®å˜æ›´å†å²
- ç´¢å¼•ä¼˜åŒ–æå‡æŸ¥è¯¢æ€§èƒ½
- æ‰¹é‡æ“ä½œå‡å°‘æ•°æ®åº“è¿æ¥

## å®‰å…¨è€ƒè™‘

### æƒé™æ§åˆ¶

- æ‰€æœ‰é…ç½®ç®¡ç†æ“ä½œéœ€è¦ç›¸åº”æƒé™
- æ”¯æŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
- æ•æ„Ÿé…ç½®é¡¹çš„é¢å¤–ä¿æŠ¤

### å®¡è®¡è¿½è¸ª

- å®Œæ•´çš„æ“ä½œå®¡è®¡æ—¥å¿—
- ä¸å¯ç¯¡æ”¹çš„å®¡è®¡è®°å½•
- æ”¯æŒå®¡è®¡æ—¥å¿—å¯¼å‡º

### æ•°æ®ä¿æŠ¤

- é…ç½®æ–‡ä»¶å¤‡ä»½ä¿æŠ¤
- æ•æ„Ÿä¿¡æ¯è„±æ•
- ä¼ è¾“è¿‡ç¨‹åŠ å¯†

## éƒ¨ç½²è¯´æ˜

### ç³»ç»Ÿè¦æ±‚

- Go 1.19+
- æ•°æ®åº“ (MySQL/PostgreSQL/SQLite)
- æ–‡ä»¶ç³»ç»Ÿå†™æƒé™

### é…ç½®æ­¥éª¤

1. ç¡®ä¿é…ç½®æ–‡ä»¶å­˜åœ¨
2. æ•°æ®åº“è¡¨è‡ªåŠ¨åˆ›å»º
3. é…ç½®ç®¡ç†å™¨è‡ªåŠ¨åˆå§‹åŒ–
4. å¯åŠ¨æ–‡ä»¶ç›‘æ§æœåŠ¡

### ç¯å¢ƒå˜é‡

```bash
# é…ç½®æ–‡ä»¶è·¯å¾„
CONFIG_PATH=./config.yaml

# åˆè§„è§„åˆ™æ–‡ä»¶è·¯å¾„
COMPLIANCE_RULES_PATH=./config/compliance_rules.json

# å¤‡ä»½ç›®å½•
BACKUP_DIR=./config_backups

# æ—¥å¿—çº§åˆ«
LOG_LEVEL=info
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥**
   - æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
   - éªŒè¯æ–‡ä»¶æƒé™
   - æŸ¥çœ‹é”™è¯¯æ—¥å¿—

2. **æ–‡ä»¶ç›‘æ§ä¸å·¥ä½œ**
   - æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶æ”¯æŒ
   - éªŒè¯æ–‡ä»¶è·¯å¾„
   - é‡å¯æœåŠ¡

3. **åˆè§„è§„åˆ™éªŒè¯å¤±è´¥**
   - æ£€æŸ¥è§„åˆ™æ ¼å¼
   - éªŒè¯å­—æ®µåå’Œæ“ä½œç¬¦
   - æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯

### è°ƒè¯•å‘½ä»¤

```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
go run . --check-config

# éªŒè¯åˆè§„è§„åˆ™
go run . --validate-rules

# æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€
curl http://localhost:8888/api/configManager/status
```

## å¼€å‘æŒ‡å—

### æ‰©å±•æ–°çš„é…ç½®ç±»å‹

1. åœ¨ `ConfigType` æšä¸¾ä¸­æ·»åŠ æ–°ç±»å‹
2. å®ç°å¯¹åº”çš„å˜æ›´å¤„ç†å™¨
3. æ·»åŠ éªŒè¯é€»è¾‘
4. æ›´æ–°APIæ¥å£

### æ·»åŠ æ–°çš„æ“ä½œç¬¦

1. åœ¨ `valid_operators` ä¸­æ·»åŠ æ–°æ“ä½œç¬¦
2. å®ç°å¯¹åº”çš„æ¯”è¾ƒé€»è¾‘
3. æ›´æ–°æ–‡æ¡£è¯´æ˜
4. æ·»åŠ æµ‹è¯•ç”¨ä¾‹

### è‡ªå®šä¹‰å®¡è®¡æ—¥å¿—

1. å®ç° `AuditLogger` æ¥å£
2. æ³¨å†Œè‡ªå®šä¹‰æ—¥å¿—å¤„ç†å™¨
3. é…ç½®æ—¥å¿—è¾“å‡ºæ ¼å¼
4. æµ‹è¯•æ—¥å¿—åŠŸèƒ½

---

## æ€»ç»“

é…ç½®ç®¡ç†ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„åŠ¨æ€é…ç½®ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒçƒ­é‡è½½ã€åˆè§„è§„åˆ™ç®¡ç†ã€å˜æ›´å®¡è®¡ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚é€šè¿‡RESTful APIå’ŒæœåŠ¡å±‚å°è£…ï¼Œå¯ä»¥è½»æ¾é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿä¸­ã€‚

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹é”™è¯¯æ—¥å¿—æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚ 
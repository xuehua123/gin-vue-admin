<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-T">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMQX JWT è®¤è¯æµ‹è¯•é¡µé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/11.1.0/jsrsasign-all-min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        .log-entry {
            padding: 6px 8px;
            border-bottom: 1px solid #e5e7eb; /* Tailwind gray-200 */
            font-size: 0.875rem;
            word-break: break-all;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-entry.success { color: #10b981; } /* Tailwind green-600 */
        .log-entry.error { color: #ef4444; } /* Tailwind red-500 */
        .log-entry.info { color: #3b82f6; } /* Tailwind blue-500 */
        .log-entry.message { color: #6b7280; } /* Tailwind gray-500 */
        .loader {
            border: 4px solid #f3f4f6; /* Tailwind gray-100 */
            border-top: 4px solid #3b82f6; /* Tailwind blue-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* è‡ªå®šä¹‰æ¶ˆæ¯å¼¹çª—æ ·å¼ */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .custom-modal {
            background-color: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .custom-modal h3 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 1.25rem;
            font-weight: 600;
        }
        .custom-modal p {
            margin-bottom: 24px;
            font-size: 1rem;
            color: #4b5563; /* Tailwind gray-600 */
        }
        .custom-modal button {
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        .custom-modal button:hover {
            background-color: #2563eb; /* Tailwind blue-600 */
        }
        .consumed-message-entry {
            padding: 4px 6px;
            border-bottom: 1px solid #e5e7eb; /* Tailwind gray-200 */
            font-size: 0.8rem;
            color: #374151; /* Tailwind gray-700 */
            word-break: break-all;
        }
         .consumed-message-entry:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto bg-white p-6 md:p-8 rounded-lg shadow-lg">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-8">EMQX JWT è®¤è¯æµ‹è¯•å·¥å…·</h1>

        <!-- EMQXé…ç½®è¯´æ˜ -->
        <div class="mb-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <h3 class="text-lg font-semibold text-blue-800 mb-3">ğŸ“‹ EMQXé…ç½®è¦æ±‚</h3>
            <div class="text-sm text-blue-700">
                <p class="mb-2">ä¸ºäº†æ”¯æŒé¡¹ç›®å®Œæ•´JWTéªŒè¯ï¼Œè¯·ç¡®ä¿EMQXé…ç½®å¦‚ä¸‹ï¼š</p>
                <div class="space-y-4">
                    <div>
                        <p class="font-semibold mb-1">ğŸ”¹ EMQXå…¼å®¹JWTï¼ˆæ¨èï¼Œå½“å‰é…ç½®ï¼‰ï¼š</p>
                        <pre class="bg-blue-100 p-3 rounded text-xs overflow-x-auto"><code># EMQXé…ç½®æ–‡ä»¶ (emqx.conf)
authentication = [
  {
    algorithm = "hmac-based"
    disconnect_after_expire = true
    enable = true
    from = password
    mechanism = jwt
    secret = "78c0f08f-9663-4c9c-a399-cc4ec36b8112"
    secret_base64_encoded = false
    use_jwks = false
    verify_claims {
      client_id = "${clientid}"
      user_id = "${username}"
      # å¯é€‰ï¼šéªŒè¯å—ä¼—å­—æ®µ
      # aud = "GVA"
    }
  }
]</code></pre>
                    </div>
                    
                    <div>
                        <p class="font-semibold mb-1">ğŸ”¹ é¡¹ç›®å®Œæ•´JWTé…ç½®ï¼ˆå¦‚éœ€æ”¯æŒçœŸå®é¡¹ç›®JWTï¼‰ï¼š</p>
                        <pre class="bg-green-100 p-3 rounded text-xs overflow-x-auto"><code># EMQXé…ç½®æ–‡ä»¶ - é¡¹ç›®å®Œæ•´JWTæ”¯æŒ
authentication = [
  {
    algorithm = "hmac-based"
    disconnect_after_expire = true
    enable = true
    from = password
    mechanism = jwt
    secret = "78c0f08f-9663-4c9c-a399-cc4ec36b8112"
    secret_base64_encoded = false
    use_jwks = false
    verify_claims {
      client_id = "${clientid}"
      # ç§»é™¤user_idéªŒè¯ï¼Œå› ä¸ºé¡¹ç›®ä¸­user_idæ˜¯UUIDæ ¼å¼
      # username = "${username}"  # å¯é€‰ï¼šéªŒè¯usernameå­—æ®µ
    }
  }
]</code></pre>
                    </div>
                </div>
                <p class="mt-2 text-xs text-blue-600">ğŸ’¡ EMQXå…¼å®¹JWTç¡®ä¿è¿æ¥æˆåŠŸï¼Œé¡¹ç›®å®Œæ•´JWTä¿æŒä¸åç«¯ä¸€è‡´çš„æ•°æ®ç»“æ„ã€‚</p>
            </div>
        </div>

        <!-- è¿æ¥è®¾ç½® -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="space-y-4 p-6 bg-gray-50 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">è¿æ¥å‚æ•°</h2>
                <div>
                    <label for="host" class="block text-sm font-medium text-gray-700">EMQX ä¸»æœº (ä¾‹å¦‚: broker.emqx.io æˆ– 192.168.1.100):</label>
                    <input type="text" id="host" value="your-emqx-broker.com" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="port" class="block text-sm font-medium text-gray-700">ç«¯å£:</label>
                    <input type="number" id="port" value="8083" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                 <div class="flex items-center">
                    <input id="ssl" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="ssl" class="ml-2 block text-sm text-gray-900">ä½¿ç”¨ SSL/TLS (ä¾‹å¦‚ wss://)</label>
                </div>
                <div>
                    <label for="clientId" class="block text-sm font-medium text-gray-700">å®¢æˆ·ç«¯ ID:</label>
                    <input type="text" id="clientId" value="nfc_test_client_001" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">ç”¨æˆ·å:</label>
                    <input type="text" id="username" value="test_user_nfc" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="secret" class="block text-sm font-medium text-gray-700">JWT å¯†é’¥ (åªè¯»):</label>
                    <input type="text" id="secret" value="78c0f08f-9663-4c9c-a399-cc4ec36b8112" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 sm:text-sm">
                </div>
            </div>

            <div class="space-y-4 p-6 bg-gray-50 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">JWT ä¿¡æ¯ä¸è¿æ¥æ§åˆ¶</h2>
                
                <!-- JWTç”Ÿæˆæ–¹å¼é€‰æ‹© -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">JWTç”Ÿæˆæ–¹å¼:</label>
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="jwtMode" value="emqx" checked class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                            <span class="ml-2 text-sm text-gray-900">EMQXå…¼å®¹JWT</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="jwtMode" value="project" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                            <span class="ml-2 text-sm text-gray-900">é¡¹ç›®å®Œæ•´JWT</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="jwtMode" value="simple" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                            <span class="ml-2 text-sm text-gray-900">ç®€åŒ–ç‰ˆJWT</span>
                        </label>
                    </div>
                    <p class="mt-1 text-xs text-gray-500">
                        <span class="font-semibold">EMQXå…¼å®¹JWT:</span> ä¸“é—¨é€‚é…EMQXéªŒè¯è§„åˆ™çš„JWTæ ¼å¼<br/>
                        <span class="font-semibold">é¡¹ç›®å®Œæ•´JWT:</span> ä¸åç«¯ç”Ÿæˆé€»è¾‘å®Œå…¨ä¸€è‡´ï¼ŒåŒ…å«æ‰€æœ‰Claimså­—æ®µ<br/>
                        <span class="font-semibold">ç®€åŒ–ç‰ˆJWT:</span> ä»…åŒ…å«åŸºç¡€å­—æ®µçš„ç®€å•JWT
                    </p>
                </div>
                
                <button id="generateJwtBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">ç”Ÿæˆ JWT</button>
                <div>
                    <label for="generatedJwt" class="block text-sm font-medium text-gray-700">ç”Ÿæˆçš„ JWT (å°†ç”¨ä½œå¯†ç ):</label>
                    <textarea id="generatedJwt" rows="8" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 sm:text-sm resize-none font-mono text-xs"></textarea>
                </div>
                
                <!-- JWTè§£ææ˜¾ç¤º -->
                <div>
                    <div class="flex justify-between items-center">
                        <label class="block text-sm font-medium text-gray-700">JWTè§£æç»“æœ:</label>
                        <button id="parseJwtBtn" class="px-3 py-1 bg-indigo-500 hover:bg-indigo-600 text-white text-xs rounded transition duration-150 ease-in-out">è§£æJWT</button>
                    </div>
                    <div id="jwtParseResult" class="mt-2 p-3 bg-gray-50 border border-gray-200 rounded text-xs font-mono max-h-40 overflow-y-auto hidden"></div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button id="connectBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">è¿æ¥</button>
                    <button id="disconnectBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out" disabled>æ–­å¼€è¿æ¥</button>
                </div>
                 <div id="status" class="mt-2 text-sm font-medium text-center">çŠ¶æ€: æœªè¿æ¥ <span id="loadingSpinner" class="hidden loader"></span></div>
            </div>
        </div>

        <!-- è®¢é˜…ã€å‘å¸ƒå’Œæ¶ˆè´¹ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="space-y-4 p-6 bg-gray-50 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">é€šç”¨è®¢é˜…</h2>
                <div>
                    <label for="subTopic" class="block text-sm font-medium text-gray-700">è®¢é˜…ä¸»é¢˜:</label>
                    <input type="text" id="subTopic" value="test/topic/general" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <button id="subscribeBtn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out" disabled>è®¢é˜…æ­¤ä¸»é¢˜</button>
            </div>

            <div class="space-y-4 p-6 bg-gray-50 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">å‘å¸ƒæ¶ˆæ¯</h2>
                <div>
                    <label for="pubTopic" class="block text-sm font-medium text-gray-700">å‘å¸ƒä¸»é¢˜:</label>
                    <input type="text" id="pubTopic" value="test/topic/pub" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="pubMessage" class="block text-sm font-medium text-gray-700">æ¶ˆæ¯å†…å®¹:</label>
                    <textarea id="pubMessage" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm resize-none">ä½ å¥½ï¼ŒEMQXï¼å½“å‰æ—¶é—´: </textarea>
                </div>
                <button id="publishBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out" disabled>å‘å¸ƒ</button>
            </div>
            
            <!-- æ–°å¢ï¼šæ¶ˆè´¹æŒ‡å®šä¸»é¢˜çš„æ¶ˆæ¯ -->
            <div class="space-y-4 p-6 bg-gray-50 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">æ¶ˆè´¹æŒ‡å®šä¸»é¢˜</h2>
                <div>
                    <label for="consumeSpecificTopicInput" class="block text-sm font-medium text-gray-700">è¦æ¶ˆè´¹çš„ä¸»é¢˜:</label>
                    <input type="text" id="consumeSpecificTopicInput" value="device/sensor/data" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <button id="startConsumeSpecificBtn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out" disabled>å¼€å§‹æ¶ˆè´¹</button>
                <button id="stopConsumeSpecificBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out mt-2" disabled>åœæ­¢æ¶ˆè´¹</button>
                <h3 class="text-md font-medium text-gray-700 mt-4">æ¥è‡ª <span id="consumingTopicName" class="font-bold"></span> çš„æ¶ˆæ¯:</h3>
                <div id="consumedMessagesArea" class="h-32 overflow-y-auto bg-white border border-gray-300 rounded-md p-2 text-sm">
                    <!-- Consumed messages will appear here -->
                </div>
            </div>
        </div>

        <!-- æ—¥å¿— -->
        <div class="p-6 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">é€šç”¨æ—¥å¿—å’Œæ¥æ”¶çš„æ‰€æœ‰æ¶ˆæ¯</h2>
                <button id="clearLogBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-1 px-3 rounded-md text-sm transition duration-150 ease-in-out">æ¸…ç©ºæ—¥å¿—</button>
            </div>
            <div id="logArea" class="h-64 overflow-y-auto bg-white border border-gray-300 rounded-md p-2 text-sm">
                <!-- æ—¥å¿—æ¡ç›®å°†åœ¨è¿™é‡Œæ·»åŠ  -->
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="mt-8 p-4 bg-green-50 border border-green-200 rounded-lg">
            <h3 class="text-lg font-semibold text-green-800 mb-3">ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
            <div class="text-sm text-green-700 space-y-2">
                <p><strong>1. JWTç”Ÿæˆæ–¹å¼ï¼š</strong></p>
                <ul class="list-disc ml-6 space-y-1">
                    <li><strong>EMQXå…¼å®¹JWTï¼š</strong>ä¸“é—¨ä¸ºEMQXè®¾è®¡ï¼Œuser_id=usernameï¼Œç¡®ä¿EMQXéªŒè¯é€šè¿‡</li>
                    <li><strong>é¡¹ç›®å®Œæ•´JWTï¼š</strong>ä¸åç«¯sys_user.goä¸­TokenNext()æ–¹æ³•ç”Ÿæˆçš„JWTç»“æ„å®Œå…¨ä¸€è‡´ï¼Œuser_id=UUID</li>
                    <li><strong>ç®€åŒ–ç‰ˆJWTï¼š</strong>ä»…åŒ…å«client_idã€user_idã€expå­—æ®µçš„ç®€å•JWTï¼Œç”¨äºå¯¹æ¯”æµ‹è¯•</li>
                </ul>
                
                <p><strong>2. æµ‹è¯•æ­¥éª¤ï¼š</strong></p>
                <ol class="list-decimal ml-6 space-y-1">
                    <li>é…ç½®EMQXæœåŠ¡å™¨åœ°å€å’Œç«¯å£</li>
                    <li>é€‰æ‹©JWTç”Ÿæˆæ–¹å¼ï¼ˆå»ºè®®å…ˆä½¿ç”¨"EMQXå…¼å®¹JWT"æµ‹è¯•è¿æ¥ï¼‰</li>
                    <li>ç‚¹å‡»"ç”ŸæˆJWT"æŒ‰é’®</li>
                    <li>ç‚¹å‡»"è§£æJWT"æŸ¥çœ‹ç”Ÿæˆçš„JWTå†…å®¹</li>
                    <li>ç‚¹å‡»"è¿æ¥"æµ‹è¯•MQTTè¿æ¥</li>
                </ol>
                
                <p><strong>3. EMQXé…ç½®å»ºè®®ï¼š</strong></p>
                <ul class="list-disc ml-6 space-y-1">
                    <li><strong>ä½¿ç”¨EMQXå…¼å®¹JWTï¼š</strong>ä¿æŒå½“å‰EMQXé…ç½®ä¸å˜</li>
                    <li><strong>ä½¿ç”¨é¡¹ç›®å®Œæ•´JWTï¼š</strong>éœ€è¦ä¿®æ”¹EMQXé…ç½®ä¸­çš„verify_claimsï¼Œå°†user_idéªŒè¯æ”¹ä¸ºå…¶ä»–å­—æ®µæˆ–ç§»é™¤</li>
                    <li><strong>æ¨èé…ç½®ï¼š</strong>åªéªŒè¯client_idå­—æ®µï¼Œè®©é¡¹ç›®å®Œæ•´JWTä¹Ÿèƒ½é€šè¿‡éªŒè¯</li>
                </ul>
                
                <p><strong>4. å­—æ®µå¯¹åº”å…³ç³»ï¼š</strong></p>
                <ul class="list-disc ml-6 space-y-1">
                    <li><code>user_id</code>: UUIDæ ¼å¼ï¼Œå¯¹åº”ç”¨æˆ·å”¯ä¸€æ ‡è¯†</li>
                    <li><code>client_id</code>: å®¢æˆ·ç«¯ä¼šè¯IDï¼Œç”¨äºMQTTè¿æ¥è¯†åˆ«</li>
                    <li><code>username</code>: ç”¨æˆ·å</li>
                    <li><code>authority_id</code>: æƒé™è§’è‰²IDï¼ˆ888ä¸ºç®¡ç†å‘˜ï¼‰</li>
                    <li><code>jti</code>: JWTå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºé˜²é‡æ”¾</li>
                    <li><code>aud</code>: å—ä¼—ï¼Œé¡¹ç›®ä¸­ä¸º["GVA"]</li>
                    <li><code>iss</code>: ç­¾å‘è€…ï¼Œé¡¹ç›®ä¸­ä¸º"qmPlus"</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰æ¶ˆæ¯å¼¹çª— -->
    <div id="customModalOverlay" class="custom-modal-overlay">
        <div class="custom-modal">
            <h3 id="modalTitle">æç¤º</h3>
            <p id="modalMessage">è¿™æ˜¯ä¸€æ¡æ¶ˆæ¯ã€‚</p>
            <button id="modalCloseBtn">å…³é—­</button>
        </div>
    </div>

    <script>
        // MQTT å®¢æˆ·ç«¯å®ä¾‹
        let client = null;
        // JWT å¯†é’¥ (ä»æ‚¨çš„é…ç½®ä¸­è·å–)
        const emqxSecret = "78c0f08f-9663-4c9c-a399-cc4ec36b8112";

        // DOM å…ƒç´ è·å–
        const hostInput = document.getElementById('host');
        const portInput = document.getElementById('port');
        const sslCheckbox = document.getElementById('ssl');
        const clientIdInput = document.getElementById('clientId');
        const usernameInput = document.getElementById('username');
        const secretInput = document.getElementById('secret'); 
        const generatedJwtTextarea = document.getElementById('generatedJwt');
        const generateJwtBtn = document.getElementById('generateJwtBtn');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const statusDiv = document.getElementById('status');
        const loadingSpinner = document.getElementById('loadingSpinner');

        const subTopicInput = document.getElementById('subTopic');
        const subscribeBtn = document.getElementById('subscribeBtn');
        const pubTopicInput = document.getElementById('pubTopic');
        const pubMessageTextarea = document.getElementById('pubMessage');
        const publishBtn = document.getElementById('publishBtn');
        const logArea = document.getElementById('logArea');
        const clearLogBtn = document.getElementById('clearLogBtn');

        // æ–°å¢ï¼šæ¶ˆè´¹æŒ‡å®šä¸»é¢˜ç›¸å…³ DOM
        const consumeSpecificTopicInput = document.getElementById('consumeSpecificTopicInput');
        const startConsumeSpecificBtn = document.getElementById('startConsumeSpecificBtn');
        const stopConsumeSpecificBtn = document.getElementById('stopConsumeSpecificBtn');
        const consumedMessagesArea = document.getElementById('consumedMessagesArea');
        const consumingTopicNameSpan = document.getElementById('consumingTopicName');

        // JWTæ¨¡å¼é€‰æ‹©ç›¸å…³DOM
        const jwtModeRadios = document.querySelectorAll('input[name="jwtMode"]');
        const parseJwtBtn = document.getElementById('parseJwtBtn');
        const jwtParseResult = document.getElementById('jwtParseResult');

        // è‡ªå®šä¹‰å¼¹çª—å…ƒç´ 
        const modalOverlay = document.getElementById('customModalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

        // çŠ¶æ€å˜é‡
        let specificallyConsumedTopic = null;
        let isSpecificallyConsuming = false;

        // JWTè§£æå‡½æ•°
        function parseJWT(token) {
            try {
                if (!token) {
                    return null;
                }
                
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('æ— æ•ˆçš„JWTæ ¼å¼');
                }
                
                const header = JSON.parse(atob(parts[0]));
                const payload = JSON.parse(atob(parts[1]));
                
                return {
                    header: header,
                    payload: payload,
                    signature: parts[2]
                };
            } catch (e) {
                throw new Error(`JWTè§£æå¤±è´¥: ${e.message}`);
            }
        }

        // æ˜¾ç¤ºJWTè§£æç»“æœ
        function showJWTParseResult() {
            const token = generatedJwtTextarea.value.trim();
            if (!token) {
                showModal('é”™è¯¯', 'JWTä¸ºç©ºï¼Œè¯·å…ˆç”ŸæˆJWTï¼');
                return;
            }
            
            try {
                const parsed = parseJWT(token);
                const result = {
                    header: parsed.header,
                    payload: parsed.payload,
                    verification: {
                        algorithm: parsed.header.alg,
                        expires_at: new Date(parsed.payload.exp * 1000).toLocaleString(),
                        issued_for: parsed.payload.aud,
                        issuer: parsed.payload.iss,
                        jwt_id: parsed.payload.jti,
                        not_before: new Date(parsed.payload.nbf * 1000).toLocaleString()
                    }
                };
                
                jwtParseResult.innerHTML = JSON.stringify(result, null, 2);
                jwtParseResult.classList.remove('hidden');
                log('JWTè§£ææˆåŠŸ', 'success');
            } catch (e) {
                jwtParseResult.innerHTML = `è§£æé”™è¯¯: ${e.message}`;
                jwtParseResult.classList.remove('hidden');
                log(`JWTè§£æå¤±è´¥: ${e.message}`, 'error');
            }
        }

        parseJwtBtn.addEventListener('click', showJWTParseResult);

        // è·å–å½“å‰é€‰æ‹©çš„JWTç”Ÿæˆæ¨¡å¼
        function getSelectedJwtMode() {
            const selectedRadio = document.querySelector('input[name="jwtMode"]:checked');
            return selectedRadio ? selectedRadio.value : 'project';
        }

        // æ ¹æ®æ¨¡å¼ç”ŸæˆJWT
        function generateJWTByMode() {
            const mode = getSelectedJwtMode();
            log(`ä½¿ç”¨${mode === 'project' ? 'é¡¹ç›®å®Œæ•´' : mode === 'emqx' ? 'EMQXå…¼å®¹' : 'ç®€åŒ–ç‰ˆ'}JWTç”Ÿæˆæ¨¡å¼`, 'info');
            
            if (mode === 'project') {
                return generateProjectJWT();
            } else if (mode === 'emqx') {
                return generateEMQXCompatibleJWT();
            } else {
                return generateJWT();
            }
        }

        generateJwtBtn.addEventListener('click', generateJWTByMode);

        // æ˜¾ç¤ºè‡ªå®šä¹‰å¼¹çª—
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalOverlay.classList.add('active');
        }

        // å…³é—­è‡ªå®šä¹‰å¼¹çª—
        modalCloseBtn.addEventListener('click', () => {
            modalOverlay.classList.remove('active');
        });
        modalOverlay.addEventListener('click', (event) => {
            if (event.target === modalOverlay) {
                modalOverlay.classList.remove('active');
            }
        });


        // æ—¥å¿—è®°å½•å‡½æ•°
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.classList.add('log-entry', type);
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight; 
        }

        clearLogBtn.addEventListener('click', () => {
            logArea.innerHTML = '';
            log('é€šç”¨æ—¥å¿—å·²æ¸…ç©ºã€‚', 'info');
        });
        
        // æ›´æ–°ä¸»UIçŠ¶æ€
        function updateMainUIState(isConnected) {
            connectBtn.disabled = isConnected;
            disconnectBtn.disabled = !isConnected;
            subscribeBtn.disabled = !isConnected; // General subscribe
            publishBtn.disabled = !isConnected;

            hostInput.disabled = isConnected;
            portInput.disabled = isConnected;
            sslCheckbox.disabled = isConnected;
            clientIdInput.disabled = isConnected;
            usernameInput.disabled = isConnected;
            generateJwtBtn.disabled = isConnected;

            if (isConnected) {
                statusDiv.innerHTML = 'çŠ¶æ€: å·²è¿æ¥ <span class="text-green-500 font-semibold">âœ”</span>';
            } else {
                statusDiv.innerHTML = 'çŠ¶æ€: æœªè¿æ¥ <span id="loadingSpinner" class="hidden loader"></span>';
            }
            loadingSpinner.classList.add('hidden');
            updateSpecificConsumeUI(); // Also update specific consume UI based on connection
        }
        
        // æ›´æ–°æ¶ˆè´¹æŒ‡å®šä¸»é¢˜UIçŠ¶æ€
        function updateSpecificConsumeUI() {
            const isConnected = client && client.isConnected();
            startConsumeSpecificBtn.disabled = !isConnected || isSpecificallyConsuming;
            stopConsumeSpecificBtn.disabled = !isConnected || !isSpecificallyConsuming;
            consumeSpecificTopicInput.disabled = !isConnected || isSpecificallyConsuming;
            consumingTopicNameSpan.textContent = isSpecificallyConsuming ? specificallyConsumedTopic : "æ— ";
        }

        // é¡¹ç›®é…ç½®å¸¸é‡ - ä¸config.yamlä¿æŒä¸€è‡´
        const PROJECT_CONFIG = {
            JWT: {
                SIGNING_KEY: "78c0f08f-9663-4c9c-a399-cc4ec36b8112",
                EXPIRES_TIME: "7d",  // 7å¤©è¿‡æœŸ
                BUFFER_TIME: "1d",   // 1å¤©ç¼“å†²æ—¶é—´
                ISSUER: "qmPlus"
            }
        };

        // æ¨¡æ‹ŸUUIDç”Ÿæˆ - ç”Ÿæˆç¬¦åˆUUID v4æ ¼å¼çš„å­—ç¬¦ä¸²
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // è§£ææ—¶é—´å­—ç¬¦ä¸²ä¸ºæ¯«ç§’æ•° - å¤åˆ¶é¡¹ç›®ä¸­ParseDurationçš„é€»è¾‘
        function parseDuration(d) {
            d = d.trim();
            
            // å¤„ç†æ ‡å‡†æ—¶é—´æ ¼å¼ (å¦‚ "1h", "30m", "24h")
            const match = d.match(/^(\d+)(ns|us|Âµs|ms|s|m|h)$/);
            if (match) {
                const value = parseInt(match[1]);
                const unit = match[2];
                switch (unit) {
                    case 'ns': return value / 1000000; // çº³ç§’è½¬æ¯«ç§’
                    case 'us': case 'Âµs': return value / 1000; // å¾®ç§’è½¬æ¯«ç§’
                    case 'ms': return value; // æ¯«ç§’
                    case 's': return value * 1000; // ç§’è½¬æ¯«ç§’
                    case 'm': return value * 60 * 1000; // åˆ†é’Ÿè½¬æ¯«ç§’
                    case 'h': return value * 60 * 60 * 1000; // å°æ—¶è½¬æ¯«ç§’
                }
            }
            
            // å¤„ç†å¤©æ•°æ ¼å¼ (å¦‚ "7d", "1d")
            if (d.includes('d')) {
                const index = d.indexOf('d');
                const days = parseInt(d.substring(0, index));
                return days * 24 * 60 * 60 * 1000; // å¤©è½¬æ¯«ç§’
            }
            
            // å¦‚æœæ˜¯çº¯æ•°å­—ï¼Œç›´æ¥è¿”å›
            const num = parseInt(d);
            if (!isNaN(num)) {
                return num;
            }
            
            return 0;
        }

        // ç”Ÿæˆé¡¹ç›®å…¼å®¹çš„JWT - å®Œå…¨å¤åˆ¶é¡¹ç›®çš„JWTç”Ÿæˆé€»è¾‘
        function generateProjectJWT() {
            const clientId = clientIdInput.value.trim();
            const username = usernameInput.value.trim();

            if (!clientId || !username) {
                showModal('é”™è¯¯', 'å®¢æˆ·ç«¯IDå’Œç”¨æˆ·åä¸èƒ½ä¸ºç©ºï¼');
                log('ç”ŸæˆJWTå¤±è´¥ï¼šå®¢æˆ·ç«¯IDå’Œç”¨æˆ·åä¸èƒ½ä¸ºç©ºã€‚', 'error');
                return null;
            }

            // æ¨¡æ‹Ÿç”¨æˆ·æ•°æ® - å¯¹åº”é¡¹ç›®ä¸­çš„BaseClaimsç»“æ„
            const userUUID = generateUUID(); // æ¨¡æ‹Ÿç”¨æˆ·UUIDï¼ˆç”¨ä½œé¡¹ç›®å†…éƒ¨IDï¼‰
            const userId = Math.floor(Math.random() * 1000) + 1; // æ¨¡æ‹Ÿç”¨æˆ·æ•°å­—ID
            const authorityId = 888; // æ¨¡æ‹Ÿæƒé™ID

            // è§£æé…ç½®ä¸­çš„æ—¶é—´
            const bufferTime = parseDuration(PROJECT_CONFIG.JWT.BUFFER_TIME);
            const expiresTime = parseDuration(PROJECT_CONFIG.JWT.EXPIRES_TIME);

            // ç”Ÿæˆå”¯ä¸€çš„JTI
            const jti = generateUUID();

            // å½“å‰æ—¶é—´
            const now = Math.floor(Date.now() / 1000);

            // æ„å»ºå®Œæ•´çš„Claimsç»“æ„ - å¯¹åº”é¡¹ç›®ä¸­çš„CustomClaims
            const header = { 
                alg: "HS256", 
                typ: "JWT" 
            };

            const payload = {
                // BaseClaims éƒ¨åˆ† - ä¸¥æ ¼æŒ‰ç…§é¡¹ç›®ç»“æ„
                user_id: userUUID,        // é¡¹ç›®çœŸå®ç»“æ„ï¼šUUIDå­—æ®µæ˜ å°„ä¸ºuser_idï¼ˆJSONæ ‡ç­¾ï¼‰
                id: userId,               // æ•°å­—ç”¨æˆ·ID
                username: username,       // ç”¨æˆ·å
                nick_name: username,      // æ˜µç§°ï¼ˆä½¿ç”¨ç”¨æˆ·åï¼‰
                authority_id: authorityId, // æƒé™ID
                client_id: clientId,      // å®¢æˆ·ç«¯ID
                
                // BufferTime
                buffer_time: Math.floor(bufferTime / 1000), // ç¼“å†²æ—¶é—´ï¼ˆç§’ï¼‰
                
                // RegisteredClaims éƒ¨åˆ†
                jti: jti,                 // JWTå”¯ä¸€æ ‡è¯†ç¬¦
                aud: ["GVA"],            // å—ä¼—ï¼ˆé¡¹ç›®ä½¿ç”¨GVAï¼‰
                nbf: now - 1,            // ç­¾åç”Ÿæ•ˆæ—¶é—´ï¼ˆæå‰1ç§’ï¼‰
                exp: now + Math.floor(expiresTime / 1000), // è¿‡æœŸæ—¶é—´
                iss: PROJECT_CONFIG.JWT.ISSUER // ç­¾åå‘è¡Œè€…
            };

            try {
                const sJWT = KJUR.jws.JWS.sign("HS256", JSON.stringify(header), JSON.stringify(payload), PROJECT_CONFIG.JWT.SIGNING_KEY);
                
                generatedJwtTextarea.value = sJWT;
                
                log('é¡¹ç›®å®Œæ•´JWTç”ŸæˆæˆåŠŸï¼ˆçœŸå®é¡¹ç›®ç»“æ„ï¼‰', 'success');
                log(`JTI: ${jti}`, 'info');
                log(`ç”¨æˆ·ID(UUID): ${userUUID}`, 'info');
                log(`ç”¨æˆ·å: ${username}`, 'info');
                log(`å®¢æˆ·ç«¯ID: ${clientId}`, 'info');
                log(`è¿‡æœŸæ—¶é—´: ${new Date((now + Math.floor(expiresTime / 1000)) * 1000).toLocaleString()}`, 'info');
                
                return sJWT;
            } catch (e) {
                console.error("JWT ç”Ÿæˆé”™è¯¯: ", e);
                log(`JWT ç”Ÿæˆé”™è¯¯: ${e.message}`, 'error');
                generatedJwtTextarea.value = `ç”Ÿæˆå¤±è´¥: ${e.message}`;
                showModal('JWT ç”Ÿæˆå¤±è´¥', e.message);
                return null;
            }
        }

        // ç”ŸæˆEMQXå…¼å®¹çš„JWT - ä¸“é—¨é€‚é…EMQXéªŒè¯è§„åˆ™
        function generateEMQXCompatibleJWT() {
            const clientId = clientIdInput.value.trim();
            const username = usernameInput.value.trim();

            if (!clientId || !username) {
                showModal('é”™è¯¯', 'å®¢æˆ·ç«¯IDå’Œç”¨æˆ·åä¸èƒ½ä¸ºç©ºï¼');
                log('ç”ŸæˆJWTå¤±è´¥ï¼šå®¢æˆ·ç«¯IDå’Œç”¨æˆ·åä¸èƒ½ä¸ºç©ºã€‚', 'error');
                return null;
            }

            // æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®
            const userUUID = generateUUID(); // æ¨¡æ‹Ÿç”¨æˆ·UUIDï¼ˆä½œä¸ºå†…éƒ¨IDï¼‰
            const userId = Math.floor(Math.random() * 1000) + 1; // æ¨¡æ‹Ÿç”¨æˆ·æ•°å­—ID
            const authorityId = 888; // æ¨¡æ‹Ÿæƒé™ID

            // è§£æé…ç½®ä¸­çš„æ—¶é—´
            const bufferTime = parseDuration(PROJECT_CONFIG.JWT.BUFFER_TIME);
            const expiresTime = parseDuration(PROJECT_CONFIG.JWT.EXPIRES_TIME);

            // ç”Ÿæˆå”¯ä¸€çš„JTI
            const jti = generateUUID();

            // å½“å‰æ—¶é—´
            const now = Math.floor(Date.now() / 1000);

            // æ„å»ºEMQXå…¼å®¹çš„Claimsç»“æ„
            const header = { 
                alg: "HS256", 
                typ: "JWT" 
            };

            const payload = {
                // EMQXéªŒè¯çš„æ ¸å¿ƒå­—æ®µ
                client_id: clientId,      // EMQXéªŒè¯ï¼š${clientid}
                user_id: username,        // EMQXéªŒè¯ï¼š${username} - å…³é”®å­—æ®µ
                
                // é¡¹ç›®æ‰©å±•å­—æ®µï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
                id: userId,               // æ•°å­—ç”¨æˆ·ID
                username: username,       // ç”¨æˆ·å
                nick_name: username,      // æ˜µç§°
                authority_id: authorityId, // æƒé™ID
                UUID: userUUID,           // å†…éƒ¨UUIDæ ‡è¯†
                
                // æ—¶é—´ç›¸å…³
                buffer_time: Math.floor(bufferTime / 1000), // ç¼“å†²æ—¶é—´ï¼ˆç§’ï¼‰
                
                // JWTæ ‡å‡†å­—æ®µ
                jti: jti,                 // JWTå”¯ä¸€æ ‡è¯†ç¬¦
                aud: ["GVA"],            // å—ä¼—
                nbf: now - 1,            // ç­¾åç”Ÿæ•ˆæ—¶é—´ï¼ˆæå‰1ç§’ï¼‰
                exp: now + Math.floor(expiresTime / 1000), // è¿‡æœŸæ—¶é—´
                iss: PROJECT_CONFIG.JWT.ISSUER // ç­¾åå‘è¡Œè€…
            };

            try {
                const sJWT = KJUR.jws.JWS.sign("HS256", JSON.stringify(header), JSON.stringify(payload), PROJECT_CONFIG.JWT.SIGNING_KEY);
                
                generatedJwtTextarea.value = sJWT;
                
                log('EMQXå…¼å®¹JWTç”ŸæˆæˆåŠŸ', 'success');
                log(`JTI: ${jti}`, 'info');
                log(`ç”¨æˆ·ID: ${username} (EMQXéªŒè¯å­—æ®µ)`, 'info');
                log(`å®¢æˆ·ç«¯ID: ${clientId} (EMQXéªŒè¯å­—æ®µ)`, 'info');
                log(`å†…éƒ¨UUID: ${userUUID}`, 'info');
                log(`è¿‡æœŸæ—¶é—´: ${new Date((now + Math.floor(expiresTime / 1000)) * 1000).toLocaleString()}`, 'info');
                
                return sJWT;
            } catch (e) {
                console.error("JWT ç”Ÿæˆé”™è¯¯: ", e);
                log(`JWT ç”Ÿæˆé”™è¯¯: ${e.message}`, 'error');
                generatedJwtTextarea.value = `ç”Ÿæˆå¤±è´¥: ${e.message}`;
                showModal('JWT ç”Ÿæˆå¤±è´¥', e.message);
                return null;
            }
        }

        // ç”Ÿæˆ JWT (ä¿ç•™åŸæ¥çš„ç®€å•ç‰ˆæœ¬ä½œä¸ºå¯¹æ¯”)
        function generateJWT() {
            const clientId = clientIdInput.value.trim();
            const username = usernameInput.value.trim();

            if (!clientId || !username) {
                showModal('é”™è¯¯', 'å®¢æˆ·ç«¯IDå’Œç”¨æˆ·åä¸èƒ½ä¸ºç©ºï¼');
                log('ç”ŸæˆJWTå¤±è´¥ï¼šå®¢æˆ·ç«¯IDå’Œç”¨æˆ·åä¸èƒ½ä¸ºç©ºã€‚', 'error');
                return null;
            }

            const header = { alg: "HS256", typ: "JWT" };
            const payload = {
                client_id: clientId,
                user_id: username,
                exp: Math.floor(Date.now() / 1000) + (60 * 60) 
            };

            try {
                const sJWT = KJUR.jws.JWS.sign("HS256", JSON.stringify(header), JSON.stringify(payload), emqxSecret);
                generatedJwtTextarea.value = sJWT;
                log('ç®€å•JWT ç”ŸæˆæˆåŠŸã€‚', 'success');
                return sJWT;
            } catch (e) {
                console.error("JWT ç”Ÿæˆé”™è¯¯: ", e);
                log(`JWT ç”Ÿæˆé”™è¯¯: ${e.message}`, 'error');
                generatedJwtTextarea.value = `ç”Ÿæˆå¤±è´¥: ${e.message}`;
                showModal('JWT ç”Ÿæˆå¤±è´¥', e.message);
                return null;
            }
        }

        function sanitizeHost(hostStr) {
            if (!hostStr) return "";
            let sanitized = hostStr.replace(/^(?:https?|wss?):\/\//i, "");
            sanitized = sanitized.replace(/\/+$/, "");
            sanitized = sanitized.replace(/^\[|\]$/g, "");
            return sanitized;
        }

        connectBtn.addEventListener('click', () => {
            let rawHost = hostInput.value.trim();
            const port = parseInt(portInput.value.trim(), 10);
            let useSSLFromCheckbox = sslCheckbox.checked;
            let finalUseSSL = useSSLFromCheckbox; 
            const clientIdVal = clientIdInput.value.trim(); // Renamed to avoid conflict
            const usernameVal = usernameInput.value.trim(); // Renamed to avoid conflict
            
            const host = sanitizeHost(rawHost);
            if (host !== rawHost) {
                log(`ä¸»æœºåå·²æ¸…ç†: ä» "${rawHost}" åˆ° "${host}"`, 'info');
                hostInput.value = host; 
            }

            if (!host || !port || !clientIdVal || !usernameVal) {
                showModal('è¿æ¥é”™è¯¯', 'ä¸»æœºã€ç«¯å£ã€å®¢æˆ·ç«¯IDå’Œç”¨æˆ·åä¸èƒ½ä¸ºç©ºï¼');
                log('è¿æ¥é”™è¯¯ï¼šä¸»æœºã€ç«¯å£ã€å®¢æˆ·ç«¯IDå’Œç”¨æˆ·åä¸èƒ½ä¸ºç©ºã€‚', 'error');
                return;
            }

            if (window.location.protocol === 'https:') {
                if (!useSSLFromCheckbox) {
                    log('é¡µé¢é€šè¿‡ HTTPS åŠ è½½ï¼Œè‡ªåŠ¨å¼ºåˆ¶ä½¿ç”¨ SSL (wss://) è¿›è¡Œ MQTT è¿æ¥ã€‚', 'info');
                    showModal('è‡ªåŠ¨ SSL/TLS', 'ç”±äºæ­¤é¡µé¢é€šè¿‡ HTTPS åŠ è½½ï¼ŒMQTT è¿æ¥å°†è‡ªåŠ¨ä½¿ç”¨å®‰å…¨çš„ SSL/TLS (wss://)ã€‚');
                    finalUseSSL = true; 
                    sslCheckbox.checked = true; 
                }
            } else {
                if (useSSLFromCheckbox) {
                    log('æç¤ºï¼šé¡µé¢é€šè¿‡ HTTP åŠ è½½ï¼Œä½†æ‚¨é€‰æ‹©äº† SSL (wss://) è¿æ¥ã€‚è¯·ç¡®ä¿æ‚¨çš„ EMQX æœåŠ¡å™¨åœ¨è¯¥ç«¯å£ä¸Šé…ç½®äº† wssã€‚', 'info');
                }
            }

            const jwtToken = generateJWTByMode();
            if (!jwtToken) {
                showModal('è¿æ¥é”™è¯¯', 'æ— æ³•ç”ŸæˆJWTï¼Œè¯·æ£€æŸ¥å®¢æˆ·ç«¯IDå’Œç”¨æˆ·åã€‚');
                return;
            }

            statusDiv.innerHTML = 'çŠ¶æ€: è¿æ¥ä¸­... <span id="loadingSpinner" class="loader"></span>';
            document.getElementById('loadingSpinner').classList.remove('hidden'); // Corrected spinner access
            
            client = new Paho.MQTT.Client(host, port, clientIdVal);

            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            const connectOptions = {
                userName: usernameVal, 
                password: jwtToken, 
                useSSL: finalUseSSL, 
                timeout: 10, 
                mqttVersion: 4, 
                onSuccess: onConnect,
                onFailure: onFailure
            };
            
            log(`å°è¯•è¿æ¥åˆ° ${finalUseSSL ? 'wss' : 'ws'}://${host}:${port} ...`, 'info');
            try {
                client.connect(connectOptions);
            } catch (error) {
                console.error("è¿æ¥æ—¶å‘ç”Ÿå¼‚å¸¸: ", error);
                log(`è¿æ¥æ—¶å‘ç”Ÿå¼‚å¸¸: ${error.message}`, 'error');
                statusDiv.innerHTML = 'çŠ¶æ€: è¿æ¥å¼‚å¸¸ <span id="loadingSpinner" class="hidden loader"></span>';
                document.getElementById('loadingSpinner').classList.add('hidden'); // Corrected spinner access
                updateMainUIState(false);
            }
        });

        function onConnect() {
            log('æˆåŠŸè¿æ¥åˆ° EMQX Broker!', 'success');
            updateMainUIState(true);
        }

        function onFailure(responseObject) {
            log(`è¿æ¥å¤±è´¥: ${responseObject.errorMessage} (é”™è¯¯ç : ${responseObject.errorCode})`, 'error');
            console.error("è¿æ¥å¤±è´¥: ", responseObject);
            showModal('è¿æ¥å¤±è´¥', `${responseObject.errorMessage} (é”™è¯¯ç : ${responseObject.errorCode})`);
            updateMainUIState(false);
            client = null; 
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                log(`è¿æ¥ä¸¢å¤±: ${responseObject.errorMessage} (é”™è¯¯ç : ${responseObject.errorCode})`, 'error');
                console.error("è¿æ¥ä¸¢å¤±: ", responseObject);
            } else {
                log('è¿æ¥å·²ä¸»åŠ¨æ–­å¼€ã€‚', 'info');
            }
            showModal('è¿æ¥å·²æ–­å¼€', responseObject.errorMessage || 'è¿æ¥å·²ç”±å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨å…³é—­ã€‚');
            
            isSpecificallyConsuming = false;
            specificallyConsumedTopic = null;
            consumedMessagesArea.innerHTML = ''; // Clear specific consumption area

            updateMainUIState(false); // This will also call updateSpecificConsumeUI
            client = null; 
        }
        
        // æ–°å¢ï¼šè®°å½•åˆ°æŒ‡å®šæ¶ˆè´¹åŒºåŸŸçš„å‡½æ•°
        function logToSpecificArea(payload) {
            const entry = document.createElement('div');
            entry.className = 'consumed-message-entry'; 
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${payload}`;
            consumedMessagesArea.appendChild(entry);
            consumedMessagesArea.scrollTop = consumedMessagesArea.scrollHeight;
        }

        function onMessageArrived(message) {
            const generalLogMessage = `æ”¶åˆ°æ¶ˆæ¯ - ä¸»é¢˜: ${message.destinationName}, å†…å®¹: ${message.payloadString}`;
            log(generalLogMessage, 'message'); 

            if (isSpecificallyConsuming && message.destinationName === specificallyConsumedTopic) {
                logToSpecificArea(message.payloadString);
            }
        }

        disconnectBtn.addEventListener('click', () => {
            if (client && client.isConnected()) {
                try {
                    client.disconnect();
                    log('æ­£åœ¨æ–­å¼€è¿æ¥...', 'info');
                     // onConnectionLost will handle UI updates
                } catch (error) {
                    console.error("æ–­å¼€è¿æ¥æ—¶å‘ç”Ÿå¼‚å¸¸: ", error);
                    log(`æ–­å¼€è¿æ¥æ—¶å‘ç”Ÿå¼‚å¸¸: ${error.message}`, 'error');
                    updateMainUIState(false); 
                    client = null;
                }
            } else {
                log('å®¢æˆ·ç«¯æœªè¿æ¥æˆ–å®ä¾‹ä¸å­˜åœ¨ã€‚', 'info');
                updateMainUIState(false); 
            }
        });

        // é€šç”¨è®¢é˜…æŒ‰é’®é€»è¾‘
        subscribeBtn.addEventListener('click', () => {
            const topic = subTopicInput.value.trim();
            if (!topic) {
                showModal('è®¢é˜…é”™è¯¯', 'è®¢é˜…ä¸»é¢˜ä¸èƒ½ä¸ºç©ºï¼');
                log('è®¢é˜…é”™è¯¯ï¼šä¸»é¢˜ä¸èƒ½ä¸ºç©ºã€‚', 'error');
                return;
            }
            if (client && client.isConnected()) {
                try {
                    client.subscribe(topic, {
                        onSuccess: function() {
                             log(`æˆåŠŸè®¢é˜…é€šç”¨ä¸»é¢˜: ${topic}`, 'success');
                        },
                        onFailure: function(responseObject) {
                            log(`è®¢é˜…é€šç”¨ä¸»é¢˜ ${topic} å¤±è´¥: ${responseObject.errorMessage}`, 'error');
                            showModal('è®¢é˜…å¤±è´¥', `è®¢é˜…é€šç”¨ä¸»é¢˜ ${topic} å¤±è´¥: ${responseObject.errorMessage}`);
                        }
                    });
                    log(`å°è¯•è®¢é˜…é€šç”¨ä¸»é¢˜: ${topic}`, 'info');
                } catch (error) {
                     console.error("è®¢é˜…æ—¶å‘ç”Ÿå¼‚å¸¸: ", error);
                     log(`è®¢é˜…æ—¶å‘ç”Ÿå¼‚å¸¸: ${error.message}`, 'error');
                     showModal('è®¢é˜…å¼‚å¸¸', `è®¢é˜…æ—¶å‘ç”Ÿå¼‚å¸¸: ${error.message}`);
                }
            } else {
                showModal('é”™è¯¯', 'å®¢æˆ·ç«¯æœªè¿æ¥ã€‚è¯·å…ˆè¿æ¥ã€‚');
                log('è®¢é˜…å¤±è´¥ï¼šå®¢æˆ·ç«¯æœªè¿æ¥ã€‚', 'error');
            }
        });
        
        // å¼€å§‹æ¶ˆè´¹æŒ‡å®šä¸»é¢˜æŒ‰é’®é€»è¾‘
        startConsumeSpecificBtn.addEventListener('click', () => {
            if (!client || !client.isConnected()) {
                showModal('é”™è¯¯', 'å®¢æˆ·ç«¯æœªè¿æ¥ã€‚è¯·å…ˆè¿æ¥ã€‚');
                log('å¼€å§‹æ¶ˆè´¹å¤±è´¥ï¼šå®¢æˆ·ç«¯æœªè¿æ¥ã€‚', 'error');
                return;
            }
            const topicToConsume = consumeSpecificTopicInput.value.trim();
            if (!topicToConsume) {
                showModal('æ¶ˆè´¹é”™è¯¯', 'è¦æ¶ˆè´¹çš„ä¸»é¢˜ä¸èƒ½ä¸ºç©ºï¼');
                log('æ¶ˆè´¹é”™è¯¯ï¼šä¸»é¢˜ä¸èƒ½ä¸ºç©ºã€‚', 'error');
                return;
            }

            client.subscribe(topicToConsume, {
                onSuccess: () => {
                    log(`æˆåŠŸå¼€å§‹æ¶ˆè´¹ä¸»é¢˜: ${topicToConsume}`, 'success');
                    specificallyConsumedTopic = topicToConsume;
                    isSpecificallyConsuming = true;
                    consumedMessagesArea.innerHTML = ''; // æ¸…ç©ºæ—§æ¶ˆæ¯
                    logToSpecificArea(`å¼€å§‹ç›‘å¬æ¥è‡ª ${topicToConsume} çš„æ¶ˆæ¯...`);
                    updateSpecificConsumeUI();
                },
                onFailure: (responseObject) => {
                    log(`å¼€å§‹æ¶ˆè´¹ä¸»é¢˜ ${topicToConsume} å¤±è´¥: ${responseObject.errorMessage}`, 'error');
                    showModal('æ¶ˆè´¹å¤±è´¥', `å¼€å§‹æ¶ˆè´¹ä¸»é¢˜ ${topicToConsume} å¤±è´¥: ${responseObject.errorMessage}`);
                }
            });
        });

        // åœæ­¢æ¶ˆè´¹æŒ‡å®šä¸»é¢˜æŒ‰é’®é€»è¾‘
        stopConsumeSpecificBtn.addEventListener('click', () => {
            if (!client || !client.isConnected() || !isSpecificallyConsuming || !specificallyConsumedTopic) {
                log('æ— éœ€åœæ­¢æ¶ˆè´¹ï¼Œæˆ–å®¢æˆ·ç«¯æœªè¿æ¥ã€‚', 'info');
                return;
            }
            const topicToUnsubscribe = specificallyConsumedTopic;
            client.unsubscribe(topicToUnsubscribe, {
                onSuccess: () => {
                    log(`å·²åœæ­¢æ¶ˆè´¹ä¸»é¢˜: ${topicToUnsubscribe}`, 'info');
                    logToSpecificArea(`å·²åœæ­¢ç›‘å¬æ¥è‡ª ${topicToUnsubscribe} çš„æ¶ˆæ¯ã€‚`);
                    specificallyConsumedTopic = null;
                    isSpecificallyConsuming = false;
                    updateSpecificConsumeUI();
                },
                onFailure: (responseObject) => {
                    log(`åœæ­¢æ¶ˆè´¹ä¸»é¢˜ ${topicToUnsubscribe} å¤±è´¥: ${responseObject.errorMessage}`, 'error');
                    showModal('åœæ­¢æ¶ˆè´¹å¤±è´¥', `åœæ­¢æ¶ˆè´¹ä¸»é¢˜ ${topicToUnsubscribe} å¤±è´¥: ${responseObject.errorMessage}`);
                }
            });
        });


        publishBtn.addEventListener('click', () => {
            const topic = pubTopicInput.value.trim();
            let messagePayload = pubMessageTextarea.value; 

            if (!topic) {
                showModal('å‘å¸ƒé”™è¯¯', 'å‘å¸ƒä¸»é¢˜ä¸èƒ½ä¸ºç©ºï¼');
                log('å‘å¸ƒé”™è¯¯ï¼šä¸»é¢˜ä¸èƒ½ä¸ºç©ºã€‚', 'error');
                return;
            }
            
            if (messagePayload.includes("å½“å‰æ—¶é—´:")) {
                 messagePayload = messagePayload.replace("å½“å‰æ—¶é—´:", `å½“å‰æ—¶é—´: ${new Date().toLocaleTimeString()}`);
            }

            if (client && client.isConnected()) {
                try {
                    const message = new Paho.MQTT.Message(messagePayload);
                    message.destinationName = topic;
                    client.send(message);
                    log(`æˆåŠŸå‘å¸ƒæ¶ˆæ¯åˆ°ä¸»é¢˜ ${topic}: ${messagePayload}`, 'success');
                } catch (error) {
                    console.error("å‘å¸ƒæ—¶å‘ç”Ÿå¼‚å¸¸: ", error);
                    log(`å‘å¸ƒæ—¶å‘ç”Ÿå¼‚å¸¸: ${error.message}`, 'error');
                    showModal('å‘å¸ƒå¼‚å¸¸', `å‘å¸ƒæ—¶å‘ç”Ÿå¼‚å¸¸: ${error.message}`);
                }
            } else {
                showModal('é”™è¯¯', 'å®¢æˆ·ç«¯æœªè¿æ¥ã€‚è¯·å…ˆè¿æ¥ã€‚');
                log('å‘å¸ƒå¤±è´¥ï¼šå®¢æˆ·ç«¯æœªè¿æ¥ã€‚', 'error');
            }
        });
        
        // åˆå§‹åŒ–UIçŠ¶æ€
        updateMainUIState(false); // This will also call updateSpecificConsumeUI
        secretInput.value = emqxSecret; 
        log('æµ‹è¯•é¡µé¢å·²åŠ è½½ã€‚è¯·è¾“å…¥è¿æ¥å‚æ•°ã€‚', 'info');

    </script>
</body>
</html>
